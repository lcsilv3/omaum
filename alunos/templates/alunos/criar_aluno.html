{% extends 'base.html' %}
{% load static alunos_extras %}

{% block title %}Criar Novo Aluno{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Criar Novo Aluno</h1>
        <a href="{% url 'alunos:listar_alunos' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Voltar para a lista
        </a>
    </div>
    
    <form method="post" enctype="multipart/form-data" id="form-aluno" novalidate>
        {% csrf_token %}
        
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {{ form.non_field_errors }}
            </div>
        {% endif %}

        <div class="alert alert-info">
            <p><strong>Atenção:</strong> Preencha todos os campos obrigatórios e certifique-se de que a data de nascimento está preenchida.</p>
        </div>

        <!-- Seção: Dados Pessoais -->
        <div class="card mb-4 border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <a class="collapse-toggle text-white text-decoration-none" data-bs-toggle="collapse" href="#dados-pessoais" role="button" aria-expanded="true" aria-controls="dados-pessoais">
                        <span class="chevron" style="transform: rotate(90deg)">▶</span> Dados Pessoais <small class="text-light">(clique para expandir/recolher)</small>
                    </a>
                </h5>
            </div>
            <div id="dados-pessoais" class="card-body collapse show">
                <!-- Seção: Identificação -->
                <div class="mb-4">
                    <h6 class="text-primary mb-3 pb-2 border-bottom">
                        <i class="fas fa-id-card me-2"></i>Identificação
                    </h6>
                    <div class="row">
                        {% for field in form %}
                            {% if field.name in 'cpf,situacao,nome' %}
                                <div class="col-md-{% if field.name == 'nome' %}12{% else %}6{% endif %} mb-3">
                                    <label for="{{ field.id_for_label }}" class="form-label">
                                        {{ field.label }}
                                        {% if field.field.required %}<span class="text-danger" title="Campo obrigatório">*</span>{% endif %}
                                    </label>
                                    {{ field }}
                                    {% if field.help_text %}
                                        <small class="form-text text-muted">{{ field.help_text }}</small>
                                    {% endif %}
                                    {% for error in field.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                
                <hr class="my-3">
                
                <!-- Seção: Informações Pessoais -->
                <div class="mb-4">
                    <h6 class="text-primary mb-3 pb-2 border-bottom">
                        <i class="fas fa-user me-2"></i>Informações Pessoais
                    </h6>
                    <div class="row">
                        {% for field in form %}
                            {% if field.name in 'data_nascimento,hora_nascimento,sexo,estado_civil,escolaridade,profissao' %}
                                <div class="col-md-6 mb-3">
                                    <label for="{{ field.id_for_label }}" class="form-label">
                                        {{ field.label }}
                                        {% if field.field.required %}<span class="text-danger" title="Campo obrigatório">*</span>{% endif %}
                                    </label>
                                    {{ field }}
                                    {% if field.help_text %}
                                        <small class="form-text text-muted">{{ field.help_text }}</small>
                                    {% endif %}
                                    {% for error in field.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                
                <hr class="my-3">
                
                <!-- Seção: Contato -->
                <div class="mb-4">
                    <h6 class="text-primary mb-3 pb-2 border-bottom">
                        <i class="fas fa-phone me-2"></i>Contato
                    </h6>
                    <div class="row">
                        {% for field in form %}
                            {% if field.name in 'email,celular,telefone' %}
                                <div class="col-md-{% if field.name == 'email' %}12{% else %}6{% endif %} mb-3">
                                    <label for="{{ field.id_for_label }}" class="form-label">
                                        {{ field.label }}
                                        {% if field.field.required %}<span class="text-danger" title="Campo obrigatório">*</span>{% endif %}
                                    </label>
                                    {{ field }}
                                    {% if field.help_text %}
                                        <small class="form-text text-muted">{{ field.help_text }}</small>
                                    {% endif %}
                                    {% for error in field.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                
                <hr class="my-3">
                
                <!-- Seção: Fotografia -->
                <div class="mb-0">
                    <h6 class="text-primary mb-3 pb-2 border-bottom">
                        <i class="fas fa-camera me-2"></i>Fotografia
                    </h6>
                    <div class="row">
                        {% for field in form %}
                            {% if field.name == 'foto' %}
                                <div class="col-md-6 mb-3">
                                    <label for="{{ field.id_for_label }}" class="form-label">
                                        <i class="fas fa-upload me-1"></i>{{ field.label }}
                                        {% if field.field.required %}<span class="text-danger" title="Campo obrigatório">*</span>{% endif %}
                                    </label>
                                    {{ field }}
                                    {% if field.help_text %}
                                        <small class="form-text text-muted"><i class="fas fa-info-circle me-1"></i>{{ field.help_text }}</small>
                                    {% endif %}
                                    {% for error in field.errors %}
                                        <div class="invalid-feedback d-block"><i class="fas fa-exclamation-triangle me-1"></i>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Seção: Nacionalidade e Naturalidade -->
        <div class="card mb-4 border-secondary">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">
                    <a class="collapse-toggle text-white text-decoration-none collapsed" data-bs-toggle="collapse" href="#nacionalidade" role="button" aria-expanded="false" aria-controls="nacionalidade">
                        <span class="chevron">&#9654;</span> Nacionalidade e Naturalidade <small class="text-light">(clique para expandir/recolher)</small>
                    </a>
                </h5>
            </div>
            <div id="nacionalidade" class="card-body collapse">
                <!-- Seção: Nacionalidade -->
                <div class="mb-4">
                    <h6 class="text-secondary mb-3 pb-2 border-bottom">
                        <i class="fas fa-flag me-2"></i>Nacionalidade
                    </h6>
                    <div class="row">
                        {% for field in form %}
                            {% if field.name == 'pais_nacionalidade' %}
                                <div class="col-md-6 mb-3">
                                    <label for="{{ field.id_for_label }}" class="form-label">
                                        {{ field.label }}
                                        {% if field.field.required %}<span class="text-danger" title="Campo obrigatório">*</span>{% endif %}
                                    </label>
                                    {{ field }}
                                    {% if field.help_text %}
                                        <small class="form-text text-muted">{{ field.help_text }}</small>
                                    {% endif %}
                                    {% for error in field.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                
                <hr class="my-3">
                
                <!-- Seção: Naturalidade -->
                <div class="mb-0">
                    <h6 class="text-secondary mb-3 pb-2 border-bottom">
                        <i class="fas fa-map-marker-alt me-2"></i>Naturalidade
                    </h6>
                    <div class="row">
                        {% for field in form %}
                            {% if field.name in 'estado_naturalidade,cidade_naturalidade' %}
                                <div class="col-md-6 mb-3">
                                    <label for="{{ field.id_for_label }}" class="form-label">
                                        {{ field.label }}
                                        {% if field.field.required %}<span class="text-danger" title="Campo obrigatório">*</span>{% endif %}
                                    </label>
                                    {{ field }}
                                    {% if field.help_text %}
                                        <small class="form-text text-muted">{{ field.help_text }}</small>
                                    {% endif %}
                                    {% for error in field.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Seção: Endereço -->
        <div class="card mb-4 border-success">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <a class="collapse-toggle text-white text-decoration-none collapsed" data-bs-toggle="collapse" href="#endereco" role="button" aria-expanded="false" aria-controls="endereco">
                        <span class="chevron">&#9654;</span> Endereço <small class="text-light">(clique para expandir/recolher)</small>
                    </a>
                </h5>
            </div>
            <div id="endereco" class="card-body collapse">
                <!-- Seção: Localização -->
                <div class="mb-4">
                    <h6 class="text-success mb-3 pb-2 border-bottom">
                        <i class="fas fa-map-marked-alt me-2"></i>Localização
                    </h6>
                    <div class="row">
                        {% for field in form %}
                            {% if field.name in 'cep,estado_ref,cidade_ref,bairro_ref' %}
                                <div class="col-md-6 mb-3">
                                    <label for="{{ field.id_for_label }}" class="form-label">
                                        {{ field.label }}
                                        {% if field.field.required %}<span class="text-danger" title="Campo obrigatório">*</span>{% endif %}
                                    </label>
                                    {{ field }}
                                    {% if field.help_text %}
                                        <small class="form-text text-muted">{{ field.help_text }}</small>
                                    {% endif %}
                                    {% for error in field.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                
                <hr class="my-3">
                
                <!-- Seção: Logradouro -->
                <div class="mb-0">
                    <h6 class="text-success mb-3 pb-2 border-bottom">
                        <i class="fas fa-home me-2"></i>Logradouro
                    </h6>
                    <div class="row">
                        {% for field in form %}
                            {% if field.name in 'rua,numero_imovel,complemento' %}
                                <div class="col-md-{% if field.name == 'rua' %}7{% elif field.name == 'numero_imovel' %}2{% else %}3{% endif %} mb-3">
                                    <label for="{{ field.id_for_label }}" class="form-label">
                                        {{ field.label }}
                                        {% if field.field.required %}<span class="text-danger" title="Campo obrigatório">*</span>{% endif %}
                                    </label>
                                    {{ field }}
                                    {% if field.help_text %}
                                        <small class="form-text text-muted">{{ field.help_text }}</small>
                                    {% endif %}
                                    {% for error in field.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Seção: Contatos de Emergência -->
        <div class="card mb-4 border-warning">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <a class="collapse-toggle text-dark text-decoration-none collapsed" data-bs-toggle="collapse" href="#contatos" role="button" aria-expanded="false" aria-controls="contatos">
                        <span class="chevron">&#9654;</span> Contatos de Emergência <small class="text-muted">(clique para expandir/recolher)</small>
                    </a>
                </h5>
            </div>
            <div id="contatos" class="card-body collapse">
                <!-- Primeiro Contato -->
                <div class="mb-4">
                    <h6 class="text-warning mb-3 pb-2 border-bottom">
                        <i class="fas fa-phone-alt me-2"></i>Primeiro Contato
                    </h6>
                    <div class="row">
                        {% for field in form %}
                            {% if field.name in 'nome_primeiro_contato,celular_primeiro_contato,tipo_relacionamento_primeiro_contato' %}
                                <div class="col-md-4 mb-3">
                                    <label for="{{ field.id_for_label }}" class="form-label">
                                        {{ field.label }}
                                        {% if field.field.required %}<span class="text-danger" title="Campo obrigatório">*</span>{% endif %}
                                    </label>
                                    {{ field }}
                                    {% if field.help_text %}
                                        <small class="form-text text-muted">{{ field.help_text }}</small>
                                    {% endif %}
                                    {% for error in field.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                
                <hr class="my-3">
                
                <!-- Segundo Contato -->
                <div class="mb-0">
                    <h6 class="text-warning mb-3 pb-2 border-bottom">
                        <i class="fas fa-phone-alt me-2"></i>Segundo Contato
                    </h6>
                    <div class="row">
                        {% for field in form %}
                            {% if field.name in 'nome_segundo_contato,celular_segundo_contato,tipo_relacionamento_segundo_contato' %}
                                <div class="col-md-4 mb-3">
                                    <label for="{{ field.id_for_label }}" class="form-label">
                                        {{ field.label }}
                                        {% if field.field.required %}<span class="text-danger" title="Campo obrigatório">*</span>{% endif %}
                                    </label>
                                    {{ field }}
                                    {% if field.help_text %}
                                        <small class="form-text text-muted">{{ field.help_text }}</small>
                                    {% endif %}
                                    {% for error in field.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Seção: Informações Médicas -->
        <div class="card mb-4 border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">
                    <a class="collapse-toggle text-white text-decoration-none collapsed" data-bs-toggle="collapse" href="#medicas" role="button" aria-expanded="false" aria-controls="medicas">
                        <span class="chevron">&#9654;</span> Informações Médicas <small class="text-light">(clique para expandir/recolher)</small>
                    </a>
                </h5>
            </div>
            <div id="medicas" class="card-body collapse">
                <!-- Seção: Tipo Sanguíneo e Convênios -->
                <div class="mb-4">
                    <h6 class="text-danger mb-3 pb-2 border-bottom">
                        <i class="fas fa-tint me-2"></i>Tipo Sanguíneo e Convênios
                    </h6>
                    <div class="row">
                        {% for field in form %}
                            {% if field.name in 'tipo_sanguineo,convenio_medico,hospital' %}
                                <div class="col-md-4 mb-3">
                                    <label for="{{ field.id_for_label }}" class="form-label">
                                        {{ field.label }}
                                        {% if field.field.required %}<span class="text-danger" title="Campo obrigatório">*</span>{% endif %}
                                    </label>
                                    {{ field }}
                                    {% if field.help_text %}
                                        <small class="form-text text-muted">{{ field.help_text }}</small>
                                    {% endif %}
                                    {% for error in field.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                
                <hr class="my-3">
                
                <!-- Seção: Alergias e Condições Médicas -->
                <div class="mb-0">
                    <h6 class="text-danger mb-3 pb-2 border-bottom">
                        <i class="fas fa-notes-medical me-2"></i>Alergias e Condições Médicas
                    </h6>
                    <div class="row">
                        {% for field in form %}
                            {% if field.name in 'alergias,condicoes_medicas_gerais' %}
                                <div class="col-md-6 mb-3">
                                    <label for="{{ field.id_for_label }}" class="form-label">
                                        {{ field.label }}
                                        {% if field.field.required %}<span class="text-danger" title="Campo obrigatório">*</span>{% endif %}
                                    </label>
                                    {{ field }}
                                    {% if field.help_text %}
                                        <small class="form-text text-muted">{{ field.help_text }}</small>
                                    {% endif %}
                                    {% for error in field.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Seção: Dados Iniciáticos Principais -->
        <div class="card mb-4 border-warning">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <a class="collapse-toggle text-dark text-decoration-none collapsed" data-bs-toggle="collapse" href="#dados-iniciaticos-principais" role="button" aria-expanded="false" aria-controls="dados-iniciaticos-principais">
                        <span class="chevron">&#9654;</span> Dados Iniciáticos Principais <small class="text-muted">(clique para expandir/recolher)</small>
                    </a>
                </h5>
            </div>
            <div id="dados-iniciaticos-principais" class="card-body collapse">
                <!-- Seção: Identificação Iniciática -->
                <div class="mb-4">
                    <h6 class="text-warning mb-3 pb-2 border-bottom">
                        <i class="fas fa-id-badge me-2"></i>Identificação Iniciática
                    </h6>
                    <div class="row">
                        {% for field in form %}
                            {% if field.name in 'numero_iniciatico,nome_iniciatico' %}
                                <div class="col-md-{% if field.name == 'numero_iniciatico' %}4{% else %}8{% endif %} mb-3">
                                    <label for="{{ field.id_for_label }}" class="form-label">
                                        {{ field.label }}
                                        {% if field.field.required %}<span class="text-danger" title="Campo obrigatório">*</span>{% endif %}
                                    </label>
                                    {{ field }}
                                    {% if field.help_text %}
                                        <small class="form-text text-muted">{{ field.help_text }}</small>
                                    {% endif %}
                                    {% for error in field.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                
                <hr class="my-3">
                
                <!-- Seção: Grau Atual -->
                <div class="mb-0">
                    <h6 class="text-warning mb-3 pb-2 border-bottom">
                        <i class="fas fa-graduation-cap me-2"></i>Grau Atual
                    </h6>
                    <div class="row">
                        {% for field in form %}
                            {% if field.name in 'grau_atual,grau_atual_automatico' %}
                                <div class="col-md-6 mb-3">
                                    <label for="{{ field.id_for_label }}" class="form-label">
                                        {{ field.label }}
                                        {% if field.field.required %}<span class="text-danger" title="Campo obrigatório">*</span>{% endif %}
                                    </label>
                                    {{ field }}
                                    {% if field.help_text %}
                                        <small class="form-text text-muted">{{ field.help_text }}</small>
                                    {% endif %}
                                    {% for error in field.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <div class="alert alert-info py-2 px-3 mt-2 mb-0" style="font-size: 0.875rem;">
                        <i class="bi bi-info-circle"></i>
                        <strong>Informação:</strong> Este campo será preenchido automaticamente quando o aluno for matriculado em uma turma.
                    </div>
                </div>
            </div>
        </div>

        <!-- Seção: Dados Iniciáticos (Cargos, Punições, etc.) -->
        <div class="card mb-4 border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <a class="collapse-toggle text-white text-decoration-none collapsed" data-bs-toggle="collapse" href="#dados-iniciaticos" role="button" aria-expanded="false" aria-controls="dados-iniciaticos">
                        <span class="chevron">&#9654;</span> Dados Iniciáticos (Cargos, Punições, etc.) <small class="text-light">(clique para expandir/recolher)</small>
                    </a>
                </h5>
            </div>
            <div id="dados-iniciaticos" class="card-body collapse">
                <div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Informação:</strong> Os registros de histórico (cargos, punições, etc.) podem ser adicionados após criar o aluno.
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between mb-5">
            <a href="{% url 'alunos:listar_alunos' %}" class="btn btn-secondary"><i class="fas fa-times"></i> Cancelar</a>
            <button type="submit" class="btn btn-primary" id="btn-salvar"><i class="fas fa-save"></i> Cadastrar Aluno</button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Script para animar os chevrons ao expandir/recolher
    const collapseToggles = document.querySelectorAll('.collapse-toggle');
    collapseToggles.forEach(toggle => {
        const targetId = toggle.getAttribute('href');
        const target = document.querySelector(targetId);
        const chevron = toggle.querySelector('.chevron');
        
        if (target && chevron) {
            target.addEventListener('show.bs.collapse', function() {
                chevron.style.transform = 'rotate(90deg)';
                toggle.classList.remove('collapsed');
                toggle.setAttribute('aria-expanded', 'true');
            });
            
            target.addEventListener('hide.bs.collapse', function() {
                chevron.style.transform = 'rotate(0deg)';
                toggle.classList.add('collapsed');
                toggle.setAttribute('aria-expanded', 'false');
            });
        }
    });
});
</script>
{% endblock %}