{% extends 'base.html' %}
{% load alunos_extras %}

{% block title %}Detalhes do Aluno: {{ aluno.nome }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Detalhes do Aluno</h1>
        <div>
            <a href="javascript:history.back()" class="btn btn-secondary me-2">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>
            <a href="{% url 'alunos:editar_aluno' aluno.cpf %}" class="btn btn-warning me-2">
                <i class="fas fa-edit"></i> Editar
            </a>
            <a href="{% url 'alunos:excluir_aluno' aluno.cpf %}" class="btn btn-danger">
                <i class="fas fa-trash"></i> Excluir
            </a>
        </div>
    </div>
    
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
    
    {% if aluno.alerta_mensagem %}
    <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle"></i> {{ aluno.alerta_mensagem }}
    </div>
    {% endif %}
    
    <div class="card mb-4 border-primary">
        <div class="card-header bg-primary text-white">
            <h5>Dados Pessoais</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>CPF:</strong> <span class="cpf-mask">{{ aluno.cpf }}</span></p>
                            <p><strong>Nome:</strong> {{ aluno.nome }}</p>
                            <p><strong>Data de Nascimento:</strong> {{ aluno.data_nascimento|date:"d/m/Y" }}</p>
                            <p><strong>Hora de Nascimento:</strong> {{ aluno.hora_nascimento|time:"H:i" }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Email:</strong> {{ aluno.email }}</p>
                            <p><strong>Sexo:</strong> {{ aluno.get_sexo_display }}</p>
                            <p><strong>Situação:</strong> 
                                {% if aluno.situacao == 'ATIVO' %}
                                    <span class="badge bg-success">{{ aluno.get_situacao_display }}</span>
                                {% elif aluno.situacao == 'AFASTADO' %}
                                    <span class="badge bg-warning">{{ aluno.get_situacao_display }}</span>
                                {% elif aluno.situacao == 'EXCLUIDO' %}
                                    <span class="badge bg-danger">{{ aluno.get_situacao_display }}</span>
                                {% elif aluno.situacao == 'FALECIDO' %}
                                    <span class="badge bg-dark">{{ aluno.get_situacao_display }}</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ aluno.get_situacao_display }}</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <!-- Moldura tracejada azul brilhante sem cabeçalho -->
                    <div class="border rounded p-3 text-center" 
                         style="border-style: dashed !important; 
                                border-color: #007bff !important; 
                                border-width: 2px !important;
                                width: 200px;  /* Largura fixa para o contêiner */
                                height: 200px; /* Altura fixa para o contêiner */
                                display: flex; 
                                align-items: center; 
                                justify-content: center;
                                overflow: hidden;
                                margin: 0 auto;">
                        {% if aluno.foto %}
                            <img src="{{ aluno.foto.url }}" alt="Foto de {{ aluno.nome }}" 
                                 style="max-width: 180px;
                                        max-height: 180px;
                                        width: auto;
                                        height: auto;
                                        object-fit: contain;
                                        display: block;">
                        {% else %}
                            <div class="text-muted">Sem foto</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    {% if aluno.esta_ativo %}
    <div class="card mb-4 border-success">
        <div class="card-header bg-success text-white">
            <h5>Instrutoria</h5>
        </div>
        <div class="card-body">
            {% if turmas_como_instrutor or turmas_como_instrutor_auxiliar or turmas_como_auxiliar_instrucao %}
                <div class="row">
                    {% if turmas_como_instrutor %}
                    <div class="col-md-4">
                        <h6 class="border-bottom pb-2">Como Instrutor Principal</h6>
                        <ul class="list-group">
                            {% for turma in turmas_como_instrutor %}
                            <li class="list-group-item">
                                <a href="{% url 'turmas:detalhar_turma' turma.id %}">{{ turma.nome }}</a>
                                <span class="badge bg-primary float-end">{{ turma.curso }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    
                    {% if turmas_como_instrutor_auxiliar %}
                    <div class="col-md-4">
                        <h6 class="border-bottom pb-2">Como Instrutor Auxiliar</h6>
                        <ul class="list-group">
                            {% for turma in turmas_como_instrutor_auxiliar %}
                            <li class="list-group-item">
                                <a href="{% url 'turmas:detalhar_turma' turma.id %}">{{ turma.nome }}</a>
                                <span class="badge bg-info float-end">{{ turma.curso }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    
                    {% if turmas_como_auxiliar_instrucao %}
                    <div class="col-md-4">
                        <h6 class="border-bottom pb-2">Como Auxiliar de Instrução</h6>
                        <ul class="list-group">
                            {% for turma in turmas_como_auxiliar_instrucao %}
                            <li class="list-group-item">
                                <a href="{% url 'turmas:detalhar_turma' turma.id %}">{{ turma.nome }}</a>
                                <span class="badge bg-success float-end">{{ turma.curso }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
            {% else %}
                <p class="text-muted">Este aluno não é instrutor em nenhuma turma ativa.</p>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
    <div class="card mb-4 border-info">
        <div class="card-header bg-info text-white">
            <h5>Dados Iniciáticos</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Número Iniciático:</strong> {{ aluno.numero_iniciatico|default:"Não informado" }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Nome Iniciático:</strong> {{ aluno.nome_iniciatico|default:"Não informado" }}</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card mb-4 border-secondary">
        <div class="card-header bg-secondary text-white">
            <h5>Nacionalidade e Naturalidade</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Nacionalidade:</strong> {{ aluno.nacionalidade }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Naturalidade:</strong> {{ aluno.naturalidade }}</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card mb-4 border-secondary">
        <div class="card-header bg-secondary text-white">
            <h5>Endereço</h5>
        </div>
        <div class="card-body">
            <p><strong>Endereço Completo:</strong> {{ aluno.rua }}, {{ aluno.numero_imovel }}
                {% if aluno.complemento %}, {{ aluno.complemento }}{% endif %}
                - {{ aluno.bairro }}, {{ aluno.cidade }}/{{ aluno.estado }} - CEP: <span class="cep-mask">{{ aluno.cep }}</span></p>
        </div>
    </div>
    
    <div class="card mb-4 border-warning">
        <div class="card-header bg-warning text-dark">
            <h5>Contatos de Emergência</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6>Primeiro Contato</h6>
                    <p><strong>Nome:</strong> {{ aluno.nome_primeiro_contato }}</p>
                    <p><strong>Celular:</strong> <span class="celular-mask">{{ aluno.celular_primeiro_contato }}</span></p>
                    <p><strong>Relacionamento:</strong> {{ aluno.tipo_relacionamento_primeiro_contato }}</p>
                </div>
                
                {% if aluno.nome_segundo_contato %}
                <div class="col-md-6">
                    <h6>Segundo Contato</h6>
                    <p><strong>Nome:</strong> {{ aluno.nome_segundo_contato }}</p>
                    <p><strong>Celular:</strong> <span class="celular-mask">{{ aluno.celular_segundo_contato }}</span></p>
                    <p><strong>Relacionamento:</strong> {{ aluno.tipo_relacionamento_segundo_contato }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="card mb-4 border-danger">
        <div class="card-header bg-danger text-white">
            <h5>Informações Médicas</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <p><strong>Tipo Sanguíneo:</strong> {{ aluno.tipo_sanguineo }}</p>
                </div>
                <div class="col-md-3">
                    <p><strong>Fator RH:</strong> {{ aluno.get_fator_rh_display }}</p>
                </div>
                <div class="col-md-3">
                    <p><strong>Convênio Médico:</strong> {{ aluno.convenio_medico|default:"Não informado" }}</p>
                </div>
                <div class="col-md-3">
                    <p><strong>Hospital:</strong> {{ aluno.hospital|default:"Não informado" }}</p>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-md-6">
                    <h6>Alergias:</h6>
                    <div class="p-2 bg-light rounded">
                        {{ aluno.alergias|default:"Nenhuma"|linebreaks }}
                    </div>
                </div>
                <div class="col-md-6">
                    <h6>Condições Médicas:</h6>
                    <div class="p-2 bg-light rounded">
                        {{ aluno.condicoes_medicas_gerais|default:"Nenhuma"|linebreaks }}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="d-flex justify-content-between mb-5">
        <a href="{% url 'alunos:listar_alunos' %}" class="btn btn-secondary">
            <i class="fas fa-list"></i> Voltar para a lista
        </a>
        <div>
            <a href="{% url 'alunos:editar_aluno' aluno.cpf %}" class="btn btn-warning me-2">
                <i class="fas fa-edit"></i> Editar
            </a>
            <a href="{% url 'alunos:excluir_aluno' aluno.cpf %}" class="btn btn-danger">
                <i class="fas fa-trash"></i> Excluir
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
<script>
    $(document).ready(function(){
        // Aplicar máscaras para exibição
        $('.cpf-mask').each(function(){
            var cpf = $(this).text().trim();
            if(cpf.length === 11) {
                $(this).text(cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4"));
            }
        });
        
        $('.cep-mask').each(function(){
            var cep = $(this).text().trim();
            if(cep.length === 8) {
                $(this).text(cep.replace(/(\d{5})(\d{3})/, "$1-$2"));
            }
        });
        
        $('.celular-mask').each(function(){
            var celular = $(this).text().trim();
            if(celular.length === 11) {
                $(this).text(celular.replace(/(\d{2})(\d{5})(\d{4})/, "($1) $2-$3"));
            } else if(celular.length === 10) {
                $(this).text(celular.replace(/(\d{2})(\d{4})(\d{4})/, "($1) $2-$3"));
            }
        });
    });
</script>
{% endblock %}