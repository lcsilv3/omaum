# ============================================================================
# OVERRIDE DE PRODU√á√ÉO
# ============================================================================
# Este arquivo sobrescreve configura√ß√µes do docker-compose.yml para PRODU√á√ÉO.
#
# ‚ö†Ô∏è  COMPAT√çVEL COM EXECU√á√ÉO SIMULT√ÇNEA:
# - Web: porta 8000 (n√£o conflita com dev na 8001)
# - Nginx: porta 80 (exclusivo de produ√ß√£o)
# - PostgreSQL: porta 5433 (dev usa 5432)
# - Redis: porta 6380 (dev usa 6379)
# - DJANGO_SETTINGS_MODULE=omaum.settings.production
# - Badge: üî¥ Vermelho "Ambiente de Produ√ß√£o"
#
# üìù Para subir SIMULT√ÇNEO com desenvolvimento:
#    docker compose --profile production -p omaum-prod \
#      --env-file ../.env.production \
#      -f docker-compose.yml \
#      -f docker-compose.prod.override.yml up -d
#
# ‚úÖ Pode rodar junto com omaum-dev sem conflitos!
# ============================================================================

services:
  omaum-db:
    ports:
      # Porta 5433 (EXTERNA) ‚Üí 5432 (INTERNA)
      # N√£o conflita com dev (5432)
      - "5433:5432"
    volumes:
      - D:/docker/omaum/prod/db:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: omaum_prod
      POSTGRES_USER: omaum_user
      POSTGRES_PASSWORD: ${OMAUM_POSTGRES_PASSWORD:-omaum_password}
  
  omaum-web:
    environment:
      - SECRET_KEY=${SECRET_KEY}
      - DEBUG=False
      - ALLOWED_HOSTS=${ALLOWED_HOSTS:-localhost,127.0.0.1}
      - DJANGO_SETTINGS_MODULE=omaum.settings.production
      - DATABASE_URL=postgresql://omaum_user:${OMAUM_POSTGRES_PASSWORD:-omaum_password}@omaum-db:5432/omaum_prod
      - REDIS_URL=redis://omaum-redis:6379/1
      - POSTGRES_DB=omaum_prod
      - POSTGRES_USER=omaum_user
      - POSTGRES_PASSWORD=${OMAUM_POSTGRES_PASSWORD:-omaum_password}
      - POSTGRES_HOST=omaum-db
    volumes:
      # ‚ùå N√ÉO montar c√≥digo fonte em produ√ß√£o!
      # C√≥digo j√° est√° copiado na imagem Docker (via Dockerfile)
      # ‚úÖ /app/static vem da imagem (COPY . /app/ no Dockerfile)
      # ‚úÖ /app/staticfiles √© onde collectstatic coleta tudo
      - D:/docker/omaum/prod/staticfiles:/app/staticfiles
      - D:/docker/omaum/prod/media:/app/media
      - D:/docker/omaum/prod/logs:/app/logs
      - "D:/Documentos Ordem/Ordem/CIIniciados/fotos:/fotos_externas:ro"
    ports:
      # ‚ö†Ô∏è  PORTA 8000 (EXTERNA e INTERNA) - Mesma do base mas em projeto diferente
      # Prod usa omaum-prod (n√£o conflita com omaum-dev na porta 8001)
      # 1. Nginx (proxy reverso na porta 80)
      # 2. Acesso direto: http://localhost:8000
      - "8000:8000"
    command: gunicorn omaum.wsgi:application --bind 0.0.0.0:8000 --workers 3 --timeout 120
  
  omaum-redis:
    ports:
      # Porta 6380 (EXTERNA) ‚Üí 6379 (INTERNA)
      # N√£o conflita com dev (6379)
      - "6380:6379"
    volumes:
      - D:/docker/omaum/prod/redis:/data
  
  omaum-celery:
    environment:
      - SECRET_KEY=${SECRET_KEY}
      - DEBUG=False
      - ALLOWED_HOSTS=${ALLOWED_HOSTS:-localhost,127.0.0.1}
      - DJANGO_SETTINGS_MODULE=omaum.settings.production
      - DATABASE_URL=postgresql://omaum_user:${POSTGRES_PASSWORD:-omaum_password}@omaum-db:5432/omaum_prod
      - REDIS_URL=redis://omaum-redis:6379/1
    volumes:
      # ‚ùå N√ÉO montar c√≥digo fonte em produ√ß√£o!
      - D:/docker/omaum/prod/media:/app/media
      - D:/docker/omaum/prod/logs:/app/logs
