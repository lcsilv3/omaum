{% extends 'base.html' %}

{% block title %}Matricular Aluno na Turma{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>Matricular Aluno na Turma: {{ turma.nome }}</h1>
    
    <div class="card mb-4">
        <div class="card-header">
            <h5>Informações da Turma</h5>
        </div>
        <div class="card-body">
            <p><strong>Nome:</strong> {{ turma.nome }}</p>
            <p><strong>Curso:</strong> {{ turma.curso.nome }}</p>
            <p><strong>Vagas Disponíveis:</strong> {{ turma.vagas_disponiveis }}</p>
        </div>
    </div>
    
    <form method="post" id="matricula-form">
        {% csrf_token %}
        <div class="mb-3">
            <label for="aluno-search" class="form-label">Buscar Aluno</label>
            <div class="input-group">
                <input type="text" class="form-control" id="aluno-search" placeholder="Digite o nome, CPF ou número iniciático do aluno...">
                <button class="btn btn-outline-secondary" type="button" id="limpar-aluno">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="aluno-results" class="list-group mt-2 d-none"></div>
            <div id="aluno-selected" class="mt-2 d-none">
                <div class="card">
                    <div class="card-body d-flex align-items-center">
                        <div id="aluno-avatar" class="me-3">
                            <!-- Avatar do aluno será inserido aqui -->
                        </div>
                        <div>
                            <h5 id="aluno-nome" class="mb-1"></h5>
                            <p id="aluno-info" class="mb-0 text-muted"></p>
                        </div>
                    </div>
                </div>
            </div>
            <input type="hidden" name="aluno" id="aluno-id" required>
        </div>
        
        <div class="d-flex justify-content-between">
            <a href="{% url 'turmas:detalhar_turma' turma.id %}" class="btn btn-secondary">Cancelar</a>
            <button type="submit" class="btn btn-primary">Matricular Aluno</button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const alunoSearch = document.getElementById('aluno-search');
        const alunoResults = document.getElementById('aluno-results');
        const alunoSelected = document.getElementById('aluno-selected');
        const alunoId = document.getElementById('aluno-id');
        const alunoNome = document.getElementById('aluno-nome');
        const alunoInfo = document.getElementById('aluno-info');
        const alunoAvatar = document.getElementById('aluno-avatar');
        const limparAluno = document.getElementById('limpar-aluno');
        const form = document.getElementById('matricula-form');
        
        let searchTimeout;
        
        // Função para buscar alunos
        function buscarAlunos(query) {
            if (query.length < 2) {
                alunoResults.classList.add('d-none');
                return;
            }
            
            fetch(`/alunos/search/?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    alunoResults.innerHTML = '';
                    
                    if (data.length === 0) {
                        const noResult = document.createElement('div');
                        noResult.className = 'list-group-item';
                        noResult.textContent = 'Nenhum aluno encontrado';
                        alunoResults.appendChild(noResult);
                    } else {
                        data.forEach(aluno => {
                            const item = document.createElement('a');
                            item.href = '#';
                            item.className = 'list-group-item list-group-item-action';
                            item.dataset.id = aluno.cpf;
                            item.dataset.nome = aluno.nome;
                            item.dataset.numero = aluno.numero_iniciatico;
                            item.dataset.foto = aluno.foto || '';
                            
                            // Criar conteúdo do item
                            let avatarHtml = '';
                            if (aluno.foto) {
                                avatarHtml = `<img src="${aluno.foto}" alt="${aluno.nome}" class="rounded-circle me-2" width="32" height="32">`;
                            } else {
                                avatarHtml = `<div class="rounded-circle bg-secondary text-white d-inline-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">${aluno.nome.charAt(0)}</div>`;
                            }
                            
                            item.innerHTML = `
                                ${avatarHtml}
                                <div>
                                    <div class="fw-bold">${aluno.nome}</div>
                                    <small class="text-muted">CPF: ${aluno.cpf} | Nº Iniciático: ${aluno.numero_iniciatico || 'N/A'}</small>
                                </div>
                            `;
                            
                            item.addEventListener('click', function(e) {
                                e.preventDefault();
                                selecionarAluno(this.dataset);
                            });
                            
                            alunoResults.appendChild(item);
                        });
                    }
                    
                    alunoResults.classList.remove('d-none');
                })
                .catch(error => {
                    console.error('Erro ao buscar alunos:', error);
                });
        }
        
        // Função para selecionar um aluno
        function selecionarAluno(dados) {
            alunoId.value = dados.id;
            alunoNome.textContent = dados.nome;
            alunoInfo.textContent = `CPF: ${dados.id} | Nº Iniciático: ${dados.numero || 'N/A'}`;
            
            // Configurar avatar
            if (dados.foto) {
                alunoAvatar.innerHTML = `<img src="${dados.foto}" alt="${dados.nome}" class="rounded-circle" width="48" height="48">`;
            } else {
                alunoAvatar.innerHTML = `<div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center" style="width: 48px; height: 48px; font-size: 20px;">${dados.nome.charAt(0)}</div>`;
            }
            
            // Mostrar seleção e esconder resultados
            alunoSelected.classList.remove('d-none');
            alunoResults.classList.add('d-none');
            alunoSearch.value = '';
        }
        
        // Função para limpar seleção
        function limparSelecao() {
            alunoId.value = '';
            alunoSelected.classList.add('d-none');
            alunoSearch.value = '';
            alunoResults.classList.add('d-none');
        }
        
        // Event listeners
        alunoSearch.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                buscarAlunos(this.value);
            }, 300);
        });
        
        limparAluno.addEventListener('click', limparSelecao);
        
        // Fechar resultados ao clicar fora
        document.addEventListener('click', function(e) {
            if (!alunoSearch.contains(e.target) && !alunoResults.contains(e.target)) {
                alunoResults.classList.add('d-none');
            }
        });
        
        // Validar formulário antes de enviar
        form.addEventListener('submit', function(e) {
            if (!alunoId.value) {
                e.preventDefault();
                alert('Por favor, selecione um aluno para matricular.');
            }
        });
    });
</script>
{% endblock %}
