{% extends 'base.html' %}

{% block title %}Editar Pagamento{% endblock %}

{% block content %}
<style>
@keyframes piscarBorda {
    0%   { box-shadow: 0 0 0 0 red; }
    50%  { box-shadow: 0 0 8px 2px red; }
    100% { box-shadow: 0 0 0 0 red; }
}
.piscar-erro {
    animation: piscarBorda 0.8s linear 2;
}
</style>
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Editar Pagamento</h1>
        <div>
            <a href="{% url 'pagamentos:detalhar_pagamento' pagamento.id %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>
        </div>
    </div>
    
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
    
    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Dados do Pagamento</h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="pagamento-form" novalidate>
                        {% csrf_token %}
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {% for error in form.non_field_errors %}
                                    <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}

                        <div class="mb-3">
                            <label class="form-label">Aluno</label>
                            <div class="input-group">
                                <div class="alert alert-info d-flex align-items-center w-100 mb-0">
                                    {% if pagamento.aluno.foto %}
                                        <img src="{{ pagamento.aluno.foto.url }}" alt="Foto de {{ pagamento.aluno.nome }}" 
                                             class="rounded-circle me-3" width="40" height="40" style="object-fit: cover;">
                                    {% else %}
                                        <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center me-3" 
                                             style="width: 40px; height: 40px; color: white;">
                                            {{ pagamento.aluno.nome|first|upper }}
                                        </div>
                                    {% endif %}
                                    <div>
                                        <strong>{{ pagamento.aluno.nome }}</strong>
                                        <br>
                                        <small>CPF: {{ pagamento.aluno.cpf }}</small>
                                    </div>
                                    <a href="{% url 'alunos:detalhar_aluno' pagamento.aluno.cpf %}" class="btn btn-sm btn-outline-primary ms-auto">
                                        <i class="fas fa-user"></i> Ver Perfil
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_valor" class="form-label">Valor (R$) <span class="text-danger">*</span></label>
                                    <input type="number" name="valor" step="0.01" required id="id_valor"
                                           class="form-control{% if form.valor.errors %} is-invalid piscar-erro{% endif %}"
                                           value="{{ form.valor.value|default_if_none:'' }}" placeholder="Ex: 100.00">
                                    {% for error in form.valor.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_data_vencimento" class="form-label">Data de Vencimento <span class="text-danger">*</span></label>
                                    <input type="date" name="data_vencimento" required id="id_data_vencimento"
                                           class="form-control{% if form.data_vencimento.errors %} is-invalid piscar-erro{% endif %}"
                                           value="{{ form.data_vencimento.value|date:'Y-m-d' }}">
                                    {% for error in form.data_vencimento.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="id_observacoes" class="form-label">Observações</label>
                            <textarea name="observacoes" cols="40" rows="3" id="id_observacoes"
                                      class="form-control{% if form.observacoes.errors %} is-invalid piscar-erro{% endif %}"
                                      placeholder="Observações adicionais...">{{ form.observacoes.value|default_if_none:'' }}</textarea>
                            {% for error in form.observacoes.errors %}
                                <div class="invalid-feedback">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="id_status" class="form-label">Status <span class="text-danger">*</span></label>
                            <select name="status" id="id_status"
                                    class="form-select{% if form.status.errors %} is-invalid piscar-erro{% endif %}" required>
                                <option value="PENDENTE" {% if form.status.value == 'PENDENTE' %}selected{% endif %}>Pendente</option>
                                <option value="PAGO" {% if form.status.value == 'PAGO' %}selected{% endif %}>Pago</option>
                                <option value="ATRASADO" {% if form.status.value == 'ATRASADO' %}selected{% endif %}>Atrasado</option>
                                <option value="CANCELADO" {% if form.status.value == 'CANCELADO' %}selected{% endif %}>Cancelado</option>
                            </select>
                            {% for error in form.status.errors %}
                                <div class="invalid-feedback">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <div class="mb-3 metodo-pagamento-container" style="display: none;">
                            <label for="id_metodo_pagamento" class="form-label">Método de Pagamento</label>
                            <select name="metodo_pagamento" id="id_metodo_pagamento"
                                    class="form-select{% if form.metodo_pagamento.errors %} is-invalid piscar-erro{% endif %}">
                                <option value="">Selecione um método</option>
                                <option value="DINHEIRO" {% if form.metodo_pagamento.value == 'DINHEIRO' %}selected{% endif %}>Dinheiro</option>
                                <option value="CARTAO_CREDITO" {% if form.metodo_pagamento.value == 'CARTAO_CREDITO' %}selected{% endif %}>Cartão de Crédito</option>
                                <option value="CARTAO_DEBITO" {% if form.metodo_pagamento.value == 'CARTAO_DEBITO' %}selected{% endif %}>Cartão de Débito</option>
                                <option value="BOLETO" {% if form.metodo_pagamento.value == 'BOLETO' %}selected{% endif %}>Boleto Bancário</option>
                                <option value="TRANSFERENCIA" {% if form.metodo_pagamento.value == 'TRANSFERENCIA' %}selected{% endif %}>Transferência</option>
                                <option value="PIX" {% if form.metodo_pagamento.value == 'PIX' %}selected{% endif %}>PIX</option>
                                <option value="OUTRO" {% if form.metodo_pagamento.value == 'OUTRO' %}selected{% endif %}>Outro</option>
                            </select>
                            {% for error in form.metodo_pagamento.errors %}
                                <div class="invalid-feedback">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3 data-pagamento-container" style="display: none;">
                                    <label for="id_data_pagamento" class="form-label">Data de Pagamento</label>
                                    <input type="date" name="data_pagamento" id="id_data_pagamento"
                                           class="form-control{% if form.data_pagamento.errors %} is-invalid piscar-erro{% endif %}"
                                           value="{{ form.data_pagamento.value|date:'Y-m-d' }}">
                                    {% for error in form.data_pagamento.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3 valor-pago-container" style="display: none;">
                                    <label for="id_valor_pago" class="form-label">Valor Pago (R$)</label>
                                    <input type="number" name="valor_pago" id="id_valor_pago"
                                           class="form-control{% if form.valor_pago.errors %} is-invalid piscar-erro{% endif %}"
                                           step="0.01" min="0" value="{{ form.valor_pago.value|default_if_none:'' }}">
                                    {% for error in form.valor_pago.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="id_comprovante" class="form-label">Comprovante de Pagamento</label>
                            <input type="file" name="comprovante" id="id_comprovante"
                                   class="form-control{% if form.comprovante.errors %} is-invalid piscar-erro{% endif %}">
                            <div class="form-text">Formatos aceitos: PDF, JPG, PNG. Tamanho máximo: 5MB</div>
                            {% for error in form.comprovante.errors %}
                                <div class="invalid-feedback">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'pagamentos:detalhar_pagamento' pagamento.id %}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Salvar Alterações
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Informações</h5>
                </div>
                <div class="card-body">
                    <p>Você está editando um pagamento existente.</p>
                    <p>Se alterar o status para "Pago", informe também a data de pagamento e o método utilizado.</p>
                    
                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-exclamation-triangle"></i> Não é possível alterar o aluno associado ao pagamento.
                    </div>
                </div>
            </div>
            
            {% if pagamento.matricula %}
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Dados da Matrícula</h5>
                </div>
                <div class="card-body">
                    <p><strong>Curso:</strong> {{ pagamento.matricula.turma.curso.nome }}</p>
                    <p><strong>Turma:</strong> {{ pagamento.matricula.turma.nome }}</p>
                    {% if pagamento.numero_parcela %}
                        <p><strong>Parcela:</strong> {{ pagamento.numero_parcela }}/{{ pagamento.total_parcelas }}</p>
                    {% endif %}
                    
                    <a href="{% url 'matriculas:detalhar_matricula' pagamento.matricula.id %}" class="btn btn-sm btn-outline-success">
                        <i class="fas fa-graduation-cap"></i> Ver Matrícula
                    </a>
                </div>
            </div>
            {% endif %}
            
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">Histórico</h5>
                </div>
                <div class="card-body">
                    <p><strong>Criado em:</strong> {{ pagamento.created_at|date:"d/m/Y H:i" }}</p>
                    <p><strong>Última atualização:</strong> {{ pagamento.updated_at|date:"d/m/Y H:i" }}</p>
                    
                    {% if pagamento.status == 'PAGO' %}
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i> Este pagamento foi registrado como pago em {{ pagamento.data_pagamento|date:"d/m/Y" }}.
                        </div>
                    {% elif pagamento.status == 'ATRASADO' %}
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle"></i> Este pagamento está atrasado há {{ pagamento.dias_atraso }} dias.
                        </div>
                    {% elif pagamento.status == 'CANCELADO' %}
                        <div class="alert alert-secondary">
                            <i class="fas fa-ban"></i> Este pagamento foi cancelado.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const statusSelect = document.getElementById('id_status');
        const dataPagamentoContainer = document.querySelector('.data-pagamento-container');
        const valorPagoContainer = document.querySelector('.valor-pago-container');
        const metodoPagamentoContainer = document.querySelector('.metodo-pagamento-container');
        
        // Função para mostrar/ocultar campos dependendo do status
        function toggleFields() {
            if (statusSelect.value === 'PAGO') {
                dataPagamentoContainer.style.display = 'block';
                valorPagoContainer.style.display = 'block';
                metodoPagamentoContainer.style.display = 'block';
                document.getElementById('id_data_pagamento').required = true;
                document.getElementById('id_valor_pago').required = true;
                
                // Se não houver data de pagamento, definir para hoje
                const dataPagamentoInput = document.getElementById('id_data_pagamento');
                if (!dataPagamentoInput.value) {
                    const hoje = new Date();
                    const ano = hoje.getFullYear();
                    const mes = String(hoje.getMonth() + 1).padStart(2, '0');
                    const dia = String(hoje.getDate()).padStart(2, '0');
                    dataPagamentoInput.value = `${ano}-${mes}-${dia}`;
                }
                
                // Se não houver valor pago, usar o valor original
                const valorPagoInput = document.getElementById('id_valor_pago');
                if (!valorPagoInput.value) {
                    valorPagoInput.value = document.getElementById('id_valor').value;
                }
            } else {
                dataPagamentoContainer.style.display = 'none';
                valorPagoContainer.style.display = 'none';
                metodoPagamentoContainer.style.display = 'none';
                document.getElementById('id_data_pagamento').required = false;
                document.getElementById('id_valor_pago').required = false;
            }
        }
        
        // Executar ao carregar a página
        toggleFields();
        
        // Adicionar evento de mudança
        statusSelect.addEventListener('change', toggleFields);
    });
</script>
{% endblock %}
