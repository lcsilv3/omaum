{% extends 'base.html' %}

{% block title %}Criar Pagamento{% endblock %}

{% block content %}
<style>
@keyframes piscarBorda {
    0%   { box-shadow: 0 0 0 0 red; }
    50%  { box-shadow: 0 0 8px 2px red; }
    100% { box-shadow: 0 0 0 0 red; }
}
.piscar-erro {
    animation: piscarBorda 0.8s linear 2;
}
</style>
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Novo Pagamento</h1>
        <a href="{% url 'pagamentos:listar_pagamentos' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Voltar
        </a>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}{% if message.tags == 'error' %} alert-danger{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    {% if form.non_field_errors %}
        <div class="alert alert-danger">
            {% for error in form.non_field_errors %}
                <div>{{ error }}</div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Dados do Pagamento</h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="pagamento-form" novalidate>
                        {% csrf_token %}
                        <!-- Busca de aluno -->
                        <div class="mb-3">
                            <label for="busca-aluno" class="form-label">Buscar Aluno <span class="text-danger">*</span></label>
                            <input type="text" id="busca-aluno" class="form-control{% if form.aluno.errors %} is-invalid piscar-erro{% endif %}" placeholder="Digite nome ou CPF do aluno" autocomplete="off">
                            <input type="hidden" name="aluno" id="id_aluno" value="{{ form.aluno.value|default_if_none:'' }}">
                            <div id="resultados-aluno" class="list-group mt-1"></div>
                            <div class="form-text">Digite pelo menos 2 letras para buscar.</div>
                            {% for error in form.aluno.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_valor" class="form-label">Valor (R$) <span class="text-danger">*</span></label>
                                    <input type="number" name="valor" step="0.01" required id="id_valor"
                                           class="form-control{% if form.valor.errors %} is-invalid piscar-erro{% endif %}"
                                           value="{{ form.valor.value|default_if_none:'' }}" placeholder="Ex: 100.00">
                                    {% for error in form.valor.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_data_vencimento" class="form-label">Data de Vencimento <span class="text-danger">*</span></label>
                                    <input type="date" name="data_vencimento" required id="id_data_vencimento"
                                           class="form-control{% if form.data_vencimento.errors %} is-invalid piscar-erro{% endif %}"
                                           value="{{ form.data_vencimento.value|default_if_none:'' }}">
                                    {% for error in form.data_vencimento.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="id_observacoes" class="form-label">Observações</label>
                            <textarea name="observacoes" cols="40" rows="3" id="id_observacoes"
                                      class="form-control{% if form.observacoes.errors %} is-invalid piscar-erro{% endif %}"
                                      placeholder="Observações adicionais...">{{ form.observacoes.value|default_if_none:'' }}</textarea>
                            {% for error in form.observacoes.errors %}
                                <div class="invalid-feedback">{{ error }}</div>
                            {% endfor %}
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_status" class="form-label">Status <span class="text-danger">*</span></label>
                                    <select name="status" id="id_status"
                                            class="form-select{% if form.status.errors %} is-invalid piscar-erro{% endif %}" required>
                                        <option value="PENDENTE" {% if form.status.value == 'PENDENTE' %}selected{% endif %}>Pendente</option>
                                        <option value="PAGO" {% if form.status.value == 'PAGO' %}selected{% endif %}>Pago</option>
                                        <option value="ATRASADO" {% if form.status.value == 'ATRASADO' %}selected{% endif %}>Atrasado</option>
                                        <option value="CANCELADO" {% if form.status.value == 'CANCELADO' %}selected{% endif %}>Cancelado</option>
                                    </select>
                                    {% for error in form.status.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3 metodo-pagamento-container" style="display: none;">
                                    <label for="id_metodo_pagamento" class="form-label">Método de Pagamento</label>
                                    <select name="metodo_pagamento" id="id_metodo_pagamento"
                                            class="form-select{% if form.metodo_pagamento.errors %} is-invalid piscar-erro{% endif %}">
                                        <option value="">Selecione um método</option>
                                        <option value="DINHEIRO" {% if form.metodo_pagamento.value == 'DINHEIRO' %}selected{% endif %}>Dinheiro</option>
                                        <option value="CARTAO_CREDITO" {% if form.metodo_pagamento.value == 'CARTAO_CREDITO' %}selected{% endif %}>Cartão de Crédito</option>
                                        <option value="CARTAO_DEBITO" {% if form.metodo_pagamento.value == 'CARTAO_DEBITO' %}selected{% endif %}>Cartão de Débito</option>
                                        <option value="BOLETO" {% if form.metodo_pagamento.value == 'BOLETO' %}selected{% endif %}>Boleto Bancário</option>
                                        <option value="TRANSFERENCIA" {% if form.metodo_pagamento.value == 'TRANSFERENCIA' %}selected{% endif %}>Transferência</option>
                                        <option value="PIX" {% if form.metodo_pagamento.value == 'PIX' %}selected{% endif %}>PIX</option>
                                        <option value="OUTRO" {% if form.metodo_pagamento.value == 'OUTRO' %}selected{% endif %}>Outro</option>
                                    </select>
                                    {% for error in form.metodo_pagamento.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3 data-pagamento-container" style="display: none;">
                                    <label for="id_data_pagamento" class="form-label">Data de Pagamento</label>
                                    <input type="date" name="data_pagamento" id="id_data_pagamento"
                                           class="form-control{% if form.data_pagamento.errors %} is-invalid piscar-erro{% endif %}"
                                           value="{{ form.data_pagamento.value|default_if_none:'' }}">
                                    {% for error in form.data_pagamento.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3 valor-pago-container" style="display: none;">
                                    <label for="id_valor_pago" class="form-label">Valor Pago (R$)</label>
                                    <input type="number" name="valor_pago" id="id_valor_pago"
                                           class="form-control{% if form.valor_pago.errors %} is-invalid piscar-erro{% endif %}"
                                           step="0.01" min="0" value="{{ form.valor_pago.value|default_if_none:'' }}">
                                    {% for error in form.valor_pago.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="id_comprovante" class="form-label">Comprovante de Pagamento</label>
                            <input type="file" name="comprovante" id="id_comprovante"
                                   class="form-control{% if form.comprovante.errors %} is-invalid piscar-erro{% endif %}">
                            <div class="form-text">Formatos aceitos: PDF, JPG, PNG. Tamanho máximo: 5MB</div>
                            {% for error in form.comprovante.errors %}
                                <div class="invalid-feedback">{{ error }}</div>
                            {% endfor %}
                        </div>
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'pagamentos:listar_pagamentos' %}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Cadastrar Pagamento
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Informações</h5>
                </div>
                <div class="card-body">
                    <p>Preencha os dados para cadastrar um novo pagamento.</p>
                    <p>Se o status for "Pago", informe também a data de pagamento e o método utilizado.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const status = document.getElementById('id_status');
        const metodoPagamentoContainer = document.querySelector('.metodo-pagamento-container');
        const dataPagamentoContainer = document.querySelector('.data-pagamento-container');
        const valorPagoContainer = document.querySelector('.valor-pago-container');
        function togglePagamentoInfo() {
            if (status.value === 'PAGO') {
                metodoPagamentoContainer.style.display = '';
                dataPagamentoContainer.style.display = '';
                valorPagoContainer.style.display = '';
            } else {
                metodoPagamentoContainer.style.display = 'none';
                dataPagamentoContainer.style.display = 'none';
                valorPagoContainer.style.display = 'none';
            }
        }
        status.addEventListener('change', togglePagamentoInfo);
        togglePagamentoInfo();

        // Autocomplete para busca de aluno
        const busca = document.getElementById('busca-aluno');
        const resultados = document.getElementById('resultados-aluno');
        const idAluno = document.getElementById('id_aluno');
        busca.addEventListener('input', function() {
            const termo = this.value;
            if (termo.length < 2) {
                resultados.innerHTML = '';
                idAluno.value = '';
                return;
            }
            fetch(`/pagamentos/alunos/buscar/?q=${encodeURIComponent(termo)}`)
                .then(resp => resp.json())
                .then(data => {
                    let html = '';
                    data.forEach(aluno => {
                        html += `<button type="button" class="list-group-item list-group-item-action" data-id="${aluno.cpf}">${aluno.nome} (${aluno.cpf})</button>`;
                    });
                    resultados.innerHTML = html;
                    document.querySelectorAll('#resultados-aluno button').forEach(btn => {
                        btn.onclick = function() {
                            idAluno.value = this.dataset.id;
                            busca.value = this.textContent;
                            resultados.innerHTML = '';
                        }
                    });
                });
        });
    });
</script>
{% endblock %}
