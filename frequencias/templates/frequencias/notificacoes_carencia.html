{% extends 'base.html' %}

{% block title %}Notificações de Carência{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>Notificações de Carência</h1>
        <a href="{% url 'frequencias:listar_frequencias' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Voltar
        </a>
    </div>
    
    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">Filtros</h5>
        </div>
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <label for="turma" class="form-label">Turma</label>
                    <select name="turma" id="turma" class="form-select select2">
                        <option value="">Todas as turmas</option>
                        {% for turma in turmas %}
                        <option value="{{ turma.id }}" {% if request.GET.turma == turma.id|stringformat:"s" %}selected{% endif %}>
                            {{ turma.nome }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="status" class="form-label">Status</label>
                    <select name="status" id="status" class="form-select">
                        <option value="">Todos os status</option>
                        <option value="PENDENTE" {% if request.GET.status == "PENDENTE" %}selected{% endif %}>Pendente</option>
                        <option value="ENVIADA" {% if request.GET.status == "ENVIADA" %}selected{% endif %}>Enviada</option>
                        <option value="LIDA" {% if request.GET.status == "LIDA" %}selected{% endif %}>Lida</option>
                        <option value="RESPONDIDA" {% if request.GET.status == "RESPONDIDA" %}selected{% endif %}>Respondida</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="periodo" class="form-label">Período</label>
                    <select name="periodo" id="periodo" class="form-select">
                        <option value="">Todos os períodos</option>
                        <option value="7" {% if request.GET.periodo == "7" %}selected{% endif %}>Últimos 7 dias</option>
                        <option value="30" {% if request.GET.periodo == "30" %}selected{% endif %}>Últimos 30 dias</option>
                        <option value="90" {% if request.GET.periodo == "90" %}selected{% endif %}>Últimos 90 dias</option>
                    </select>
                </div>
                <div class="col-12 mt-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-filter"></i> Filtrar
                    </button>
                    <a href="{% url 'frequencias:notificacoes_carencia' %}" class="btn btn-secondary">
                        <i class="fas fa-broom"></i> Limpar Filtros
                    </a>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Estatísticas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">Total de Notificações</h5>
                    <p class="card-text display-4">{{ total_notificacoes }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <h5 class="card-title">Pendentes</h5>
                    <p class="card-text display-4">{{ notificacoes_pendentes }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">Enviadas</h5>
                    <p class="card-text display-4">{{ notificacoes_enviadas }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">Respondidas</h5>
                    <p class="card-text display-4">{{ notificacoes_respondidas }}</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Lista de notificações -->
    <div class="card">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Lista de Notificações</h5>
            <div>
                <button id="btn-enviar-selecionadas" class="btn btn-primary btn-sm" disabled>
                    <i class="fas fa-paper-plane"></i> Enviar Selecionadas
                </button>
                <button id="btn-marcar-todas" class="btn btn-secondary btn-sm">
                    <i class="fas fa-check-square"></i> Marcar Todas
                </button>
                <button id="btn-desmarcar-todas" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-square"></i> Desmarcar Todas
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="selecionar-todas">
                                </div>
                            </th>
                            <th>Aluno</th>
                            <th>Turma</th>
                            <th>Período</th>
                            <th>Percentual</th>
                            <th>Status</th>
                            <th>Data de Envio</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for notificacao in notificacoes %}
                        <tr>
                            <td>
                                <div class="form-check">
                                    <input class="form-check-input notificacao-checkbox" type="checkbox" 
                                           value="{{ notificacao.id }}" 
                                           {% if notificacao.status != 'PENDENTE' %}disabled{% endif %}>
                                </div>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    {% if notificacao.carencia.aluno.foto %}
                                    <img src="{{ notificacao.carencia.aluno.foto.url }}" alt="{{ notificacao.carencia.aluno.nome }}" 
                                         class="rounded-circle me-2" width="40" height="40">
                                    {% else %}
                                    <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center me-2"
                                         style="width: 40px; height: 40px; color: white;">
                                        {{ notificacao.carencia.aluno.nome|first|upper }}
                                    </div>
                                    {% endif %}
                                    <div>
                                        <div>{{ notificacao.carencia.aluno.nome }}</div>
                                        <small class="text-muted">{{ notificacao.carencia.aluno.cpf }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>{{ notificacao.carencia.frequencia_mensal.turma.nome }}</td>
                            <td>{{ notificacao.carencia.frequencia_mensal.get_mes_display }}/{{ notificacao.carencia.frequencia_mensal.ano }}</td>
                            <td>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar bg-danger" role="progressbar" 
                                         style="width: {{ notificacao.carencia.percentual_presenca }}%;" 
                                         aria-valuenow="{{ notificacao.carencia.percentual_presenca }}" 
                                         aria-valuemin="0" aria-valuemax="100">
                                        {{ notificacao.carencia.percentual_presenca }}%
                                    </div>
                                </div>
                            </td>
                            <td>
                                {% if notificacao.status == 'PENDENTE' %}
                                <span class="badge bg-warning text-dark">Pendente</span>
                                {% elif notificacao.status == 'ENVIADA' %}
                                <span class="badge bg-info">Enviada</span>
                                {% elif notificacao.status == 'LIDA' %}
                                <span class="badge bg-primary">Lida</span>
                                {% elif notificacao.status == 'RESPONDIDA' %}
                                <span class="badge bg-success">Respondida</span>
                                {% endif %}
                            </td>
                            <td>{{ notificacao.data_envio|date:"d/m/Y H:i"|default:"-" }}</td>
                            <td>
                                <div class="btn-group">
                                    <a href="{% url 'frequencias:detalhar_notificacao' notificacao.id %}" 
                                       class="btn btn-sm btn-info" title="Ver detalhes">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    {% if notificacao.status == 'PENDENTE' %}
                                    <a href="{% url 'frequencias:enviar_notificacao' notificacao.id %}" 
                                       class="btn btn-sm btn-primary" title="Enviar notificação">
                                        <i class="fas fa-paper-plane"></i>
                                    </a>
                                    {% endif %}
                                    {% if notificacao.status == 'RESPONDIDA' %}
                                    <a href="{% url 'frequencias:visualizar_resposta' notificacao.id %}" 
                                       class="btn btn-sm btn-success" title="Ver resposta">
                                        <i class="fas fa-reply"></i>
                                    </a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" class="text-center py-4">
                                <div class="alert alert-info mb-0">
                                    Nenhuma notificação encontrada com os filtros selecionados.
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Paginação -->
            {% if page_obj.has_other_pages %}
            <nav aria-label="Paginação" class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                            <i class="fas fa-angle-double-left"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                            <i class="fas fa-angle-left"></i>
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link"><i class="fas fa-angle-double-left"></i></span>
                    </li>
                    <li class="page-item disabled">
                        <span class="page-link"><i class="fas fa-angle-left"></i></span>
                    </li>
                    {% endif %}
                    
                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                {{ num }}
                            </a>
                        </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                            <i class="fas fa-angle-right"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                            <i class="fas fa-angle-double-right"></i>
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link"><i class="fas fa-angle-right"></i></span>
                    </li>
                    <li class="page-item disabled">
                        <span class="page-link"><i class="fas fa-angle-double-right"></i></span>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
        <div class="card-footer">
            <div class="d-flex justify-content-between align-items-center">
                <span>Total: {{ page_obj.paginator.count }} notificações</span>
                <span>Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmação para envio em massa -->
<div class="modal fade" id="modalEnvioMassa" tabindex="-1" aria-labelledby="modalEnvioMassaLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEnvioMassaLabel">Confirmar Envio de Notificações</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <p>Você está prestes a enviar <span id="qtd-notificacoes-selecionadas">0</span> notificações de carência.</p>
                <p>Esta ação enviará e-mails para os alunos selecionados. Deseja continuar?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btn-confirmar-envio">Confirmar Envio</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar Select2 para melhorar a experiência de seleção
        $('.select2').select2({
            theme: 'bootstrap-5',
            width: '100%'
        });
        
        // Gerenciar seleção de notificações
        const checkboxes = document.querySelectorAll('.notificacao-checkbox');
        const selecionarTodas = document.getElementById('selecionar-todas');
        const btnEnviarSelecionadas = document.getElementById('btn-enviar-selecionadas');
        const btnMarcarTodas = document.getElementById('btn-marcar-todas');
        const btnDesmarcarTodas = document.getElementById('btn-desmarcar-todas');
        const qtdNotificacoesSelecionadas = document.getElementById('qtd-notificacoes-selecionadas');
        
        // Modal de confirmação
        const modalEnvioMassa = new bootstrap.Modal(document.getElementById('modalEnvioMassa'));
        const btnConfirmarEnvio = document.getElementById('btn-confirmar-envio');
        
        // Função para atualizar o estado do botão de envio
        function atualizarBotaoEnvio() {
            const selecionadas = document.querySelectorAll('.notificacao-checkbox:checked');
            btnEnviarSelecionadas.disabled = selecionadas.length === 0;
            qtdNotificacoesSelecionadas.textContent = selecionadas.length;
        }
        
        // Evento para o checkbox "selecionar todas"
        selecionarTodas.addEventListener('change', function() {
            checkboxes.forEach(checkbox => {
                if (!checkbox.disabled) {
                    checkbox.checked = this.checked;
                }
            });
            atualizarBotaoEnvio();
        });
        
        // Evento para os checkboxes individuais
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                atualizarBotaoEnvio();
                
                // Verificar se todos estão selecionados
                const todosCheckboxes = document.querySelectorAll('.notificacao-checkbox:not(:disabled)');
                const todosSelecionados = document.querySelectorAll('.notificacao-checkbox:not(:disabled):checked');
                selecionarTodas.checked = todosCheckboxes.length === todosSelecionados.length;
            });
        });
        
        // Botão para marcar todas
        btnMarcarTodas.addEventListener('click', function() {
            checkboxes.forEach(checkbox => {
                if (!checkbox.disabled) {
                    checkbox.checked = true;
                }
            });
            selecionarTodas.checked = true;
            atualizarBotaoEnvio();
        });
        
        // Botão para desmarcar todas
        btnDesmarcarTodas.addEventListener('click', function() {
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            selecionarTodas.checked = false;
            atualizarBotaoEnvio();
        });
        
        // Botão para enviar selecionadas
        btnEnviarSelecionadas.addEventListener('click', function() {
            modalEnvioMassa.show();
        });
        
        // Botão para confirmar envio
        btnConfirmarEnvio.addEventListener('click', function() {
            // Obter IDs das notificações selecionadas
            const selecionadas = Array.from(document.querySelectorAll('.notificacao-checkbox:checked')).map(cb => cb.value);
            
            // Enviar requisição AJAX para o backend
            fetch('{% url "frequencias:enviar_notificacoes_massa" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    notificacoes: selecionadas
                })
            })
            .then(response => response.json())
            .then(data => {
                modalEnvioMassa.hide();
                
                if (data.success) {
                    // Mostrar mensagem de sucesso
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show';
                    alertDiv.innerHTML = `
                        <strong>Sucesso!</strong> ${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
                    `;
                    document.querySelector('.container').prepend(alertDiv);
                    
                    // Recarregar a página após 2 segundos
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    // Mostrar mensagem de erro
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-danger alert-dismissible fade show';
                    alertDiv.innerHTML = `
                        <strong>Erro!</strong> ${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
                    `;
                    document.querySelector('.container').prepend(alertDiv);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                modalEnvioMassa.hide();
                
                // Mostrar mensagem de erro
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger alert-dismissible fade show';
                alertDiv.innerHTML = `
                    <strong>Erro!</strong> Ocorreu um erro ao processar sua solicitação.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
                `;
                document.querySelector('.container').prepend(alertDiv);
            });
        });
        
        // Inicializar o estado do botão
        atualizarBotaoEnvio();
    });
</script>
{% endblock %}