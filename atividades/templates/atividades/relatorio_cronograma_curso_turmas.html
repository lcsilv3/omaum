{% extends 'base.html' %}

{% block extra_css %}
<style>
  .relatorio-cronograma .card-resumo {
    min-height: 120px;
  }
  .relatorio-cronograma .filtros-form .form-control,
  .relatorio-cronograma .filtros-form .form-select {
    min-height: 42px;
  }
  .relatorio-cronograma .acoes-exportacao .btn {
    min-width: 120px;
  }
</style>
{% endblock %}

{% block content %}
<div class="container relatorio-cronograma">
  <div class="d-flex flex-wrap align-items-center justify-content-between mb-4 gap-3">
    <div>
      <h1 class="h3 mb-1">{{ titulo }}</h1>
      <small class="text-muted">{{ nome_organizacao }} · {{ nome_sistema }}</small>
      <p class="text-muted mb-0">Emitido em {{ data_emissao }}</p>
    </div>
    <div class="acoes-exportacao text-end">
      <a class="btn btn-outline-secondary btn-sm" href="{% url 'atividades:exportar_relatorio_cronograma' 'csv' %}?{{ query_params }}">CSV</a>
      <a class="btn btn-outline-secondary btn-sm" href="{% url 'atividades:exportar_relatorio_cronograma' 'excel' %}?{{ query_params }}">Excel</a>
      <a class="btn btn-outline-secondary btn-sm" href="{% url 'atividades:exportar_relatorio_cronograma' 'pdf' %}?{{ query_params }}">PDF</a>
    </div>
  </div>

  <div class="card mb-4 filtros-form">
    <div class="card-header">
      <strong>Filtros do relatório</strong>
    </div>
    <div class="card-body">
      <form id="form-cronograma" class="row g-3" autocomplete="off">
        <div class="col-md-4">
          <label for="id_curso" class="form-label">Curso</label>
          <select id="id_curso" name="curso" class="form-select">
            <option value="">Todos</option>
            {% for curso in cursos %}
              <option value="{{ curso.id }}" {% if filtros.curso_id == curso.id %}selected{% endif %}>{{ curso.nome }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label for="id_turma" class="form-label">Turma</label>
          <select id="id_turma" name="turma" class="form-select">
            <option value="">Todas</option>
            {% for turma in turmas %}
              <option value="{{ turma.id }}" {% if filtros.turma_id == turma.id %}selected{% endif %}>{{ turma.nome }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label for="id_status" class="form-label">Status da atividade</label>
          <select id="id_status" name="status" class="form-select">
            <option value="">Todos</option>
            {% for status in status_choices %}
              <option value="{{ status.value }}" {% if filtros.status == status.value %}selected{% endif %}>{{ status.label }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label for="id_responsavel" class="form-label">Responsável</label>
          <select id="id_responsavel" name="responsavel" class="form-select">
            <option value="">Todos</option>
            {% for responsavel in responsaveis %}
              <option value="{{ responsavel.value }}" {% if filtros.responsavel == responsavel.value %}selected{% endif %}>{{ responsavel.label }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label for="id_data_inicio" class="form-label">Data inicial</label>
          <input id="id_data_inicio" type="date" name="data_inicio" class="form-control" value="{% if filtros.data_inicio %}{{ filtros.data_inicio|date:'Y-m-d' }}{% endif %}">
        </div>
        <div class="col-md-4">
          <label for="id_data_fim" class="form-label">Data final</label>
          <input id="id_data_fim" type="date" name="data_fim" class="form-control" value="{% if filtros.data_fim %}{{ filtros.data_fim|date:'Y-m-d' }}{% endif %}">
        </div>
        <div class="col-12 d-flex justify-content-end">
          <button type="submit" class="btn btn-primary mt-2">Aplicar filtros</button>
        </div>
      </form>
    </div>
  </div>

  <div id="cronograma-dados-container">
    {% include 'atividades/partials/relatorio_cronograma_tabela.html' with relatorio=relatorio descricao_filtros=descricao_filtros %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  (function() {
    const form = document.getElementById('form-cronograma');
    const campoCurso = document.getElementById('id_curso');
    const campoTurma = document.getElementById('id_turma');
    const campoStatus = document.getElementById('id_status');
    const campoResponsavel = document.getElementById('id_responsavel');
    const campoDataInicio = document.getElementById('id_data_inicio');
    const campoDataFim = document.getElementById('id_data_fim');
    const container = document.getElementById('cronograma-dados-container');
    const endpointTabela = "{% url 'atividades:ajax_relatorio_cronograma_tabela' %}";
    const endpointOpcoes = "{% url 'atividades:ajax_relatorio_cronograma_opcoes' %}";

    function montarQueryString(formData) {
      const params = new URLSearchParams();
      for (const [chave, valor] of formData.entries()) {
        if (valor) {
          params.append(chave, valor);
        }
      }
      return params.toString();
    }

    async function atualizarTabela() {
      const params = montarQueryString(new FormData(form));
      const url = params ? `${endpointTabela}?${params}` : endpointTabela;
      const resposta = await fetch(url, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });

      if (!resposta.ok) {
        return;
      }

      const html = await resposta.text();
      container.innerHTML = html;
    }

    async function atualizarOpcoes() {
      const params = new URLSearchParams();
      if (campoCurso.value) {
        params.append('curso', campoCurso.value);
      }

      const consulta = params.toString();
      const url = consulta ? `${endpointOpcoes}?${consulta}` : endpointOpcoes;
      const resposta = await fetch(url, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });

      if (!resposta.ok) {
        return;
      }

      const dados = await resposta.json();

      const turmaSelecionada = campoTurma.value;
      campoTurma.innerHTML = '<option value="">Todas</option>';
      (dados.turmas || []).forEach((turma) => {
        const option = document.createElement('option');
        option.value = turma.id;
        option.textContent = turma.nome;
        if (String(turma.id) === turmaSelecionada) {
          option.selected = true;
        }
        campoTurma.appendChild(option);
      });

      const responsavelSelecionado = campoResponsavel.value;
      campoResponsavel.innerHTML = '<option value="">Todos</option>';
      (dados.responsaveis || []).forEach((resp) => {
        const option = document.createElement('option');
        option.value = resp.value;
        option.textContent = resp.label;
        if (resp.value === responsavelSelecionado) {
          option.selected = true;
        }
        campoResponsavel.appendChild(option);
      });
    }

    form.addEventListener('submit', function(evento) {
      evento.preventDefault();
      atualizarTabela();
    });

    campoCurso.addEventListener('change', function() {
      atualizarOpcoes().then(atualizarTabela);
    });

    [campoTurma, campoStatus, campoResponsavel, campoDataInicio, campoDataFim]
      .filter(Boolean)
      .forEach((campo) => {
        campo.addEventListener('change', atualizarTabela);
      });
  })();
</script>
{% endblock %}
