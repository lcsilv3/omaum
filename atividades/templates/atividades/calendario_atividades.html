{% extends 'base.html' %}

{% block title %}Calendário de Atividades{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css">
<style>
    #calendar {
        max-width: 1100px;
        margin: 0 auto;
    }
    
    .fc-event {
        cursor: pointer;
    }
    
    .fc-event-title {
        font-weight: bold;
    }
    
    .fc-event-time {
        font-size: 0.9em;
    }
    
    .academica-event {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }
    
    .ritualistica-event {
        background-color: #17a2b8;
        border-color: #17a2b8;
    }
    
    .agendada-event {
        border-left: 5px solid #ffc107;
    }
    
    .em_andamento-event {
        border-left: 5px solid #0dcaf0;
    }
    
    .concluida-event {
        border-left: 5px solid #198754;
    }
    
    .cancelada-event {
        border-left: 5px solid #dc3545;
        text-decoration: line-through;
        opacity: 0.7;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Calendário de Atividades</h1>
        <div>
            <a href="javascript:history.back()" class="btn btn-secondary me-2">Voltar</a>
            <a href="{% url 'atividades:dashboard_atividades' %}" class="btn btn-success me-2">
                <i class="fas fa-chart-bar"></i> Dashboard
            </a>
            <a href="{% url 'atividades:relatorio_atividades' %}" class="btn btn-warning me-2">
                <i class="fas fa-file-alt"></i> Relatórios
            </a>
            <div class="btn-group">
                <a href="{% url 'atividades:listar_atividades_academicas' %}" class="btn btn-outline-primary">Atividades Acadêmicas</a>
                <a href="{% url 'atividades:listar_atividades_ritualisticas' %}" class="btn btn-outline-info">Atividades Ritualísticas</a>
            </div>
        </div>
    </div>
    
    <div class="card mb-4">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Filtros</h5>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="mostrar-concluidas" checked>
                    <label class="form-check-label" for="mostrar-concluidas">Mostrar atividades concluídas</label>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="filtro-tipo" class="form-label">Tipo de Atividade</label>
                        <select id="filtro-tipo" class="form-select">
                            <option value="todas" selected>Todas</option>
                            <option value="academicas">Acadêmicas</option>
                            <option value="ritualisticas">Ritualísticas</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="filtro-turma" class="form-label">Turma</label>
                        <select id="filtro-turma" class="form-select">
                            <option value="todas" selected>Todas</option>
                            {% for turma in turmas %}
                                <option value="{{ turma.id }}">{{ turma.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <button id="aplicar-filtros" class="btn btn-primary">
                    <i class="fas fa-filter"></i> Aplicar Filtros
                </button>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-body">
            <div id="calendar"></div>
        </div>
    </div>
    
    <!-- Modal para detalhes da atividade -->
    <div class="modal fade" id="atividadeModal" tabindex="-1" aria-labelledby="atividadeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="atividadeModalLabel">Detalhes da Atividade</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body" id="atividadeModalBody">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                        <p>Carregando detalhes da atividade...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <a href="#" class="btn btn-primary" id="verDetalhesBtn">Ver Detalhes Completos</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/locales-all.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar o calendário
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay,listMonth'
            },
            locale: 'pt-br',
            buttonText: {
                today: 'Hoje',
                month: 'Mês',
                week: 'Semana',
                day: 'Dia',
                list: 'Lista'
            },
            events: function(info, successCallback, failureCallback) {
                // Obter filtros
                const tipoFiltro = document.getElementById('filtro-tipo').value;
                const turmaFiltro = document.getElementById('filtro-turma').value;
                const mostrarConcluidas = document.getElementById('mostrar-concluidas').checked;
                
                // Construir URL com parâmetros de filtro
                let url = '{% url "atividades:api_eventos_calendario" %}';
                url += '?start=' + info.startStr + '&end=' + info.endStr;
                url += '&tipo=' + tipoFiltro;
                url += '&turma=' + turmaFiltro;
                url += '&concluidas=' + (mostrarConcluidas ? '1' : '0');
                
                // Fazer requisição AJAX
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        successCallback(data);
                    })
                    .catch(error => {
                        console.error('Erro ao carregar eventos:', error);
                        failureCallback(error);
                    });
            },
            eventClick: function(info) {
                // Abrir modal com detalhes do evento
                const modal = new bootstrap.Modal(document.getElementById('atividadeModal'));
                const modalBody = document.getElementById('atividadeModalBody');
                const verDetalhesBtn = document.getElementById('verDetalhesBtn');
                
                // Limpar conteúdo anterior e mostrar loader
                modalBody.innerHTML = `
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                        <p>Carregando detalhes da atividade...</p>
                    </div>
                `;
                
                // Configurar link para detalhes completos
                const eventoId = info.event.id;
                const tipoEvento = info.event.extendedProps.tipo;
                
                if (tipoEvento === 'academica') {
                    verDetalhesBtn.href = '{% url "atividades:detalhar_atividade_academica" 0 %}'.replace('0', eventoId);
                } else {
                    verDetalhesBtn.href = '{% url "atividades:detalhar_atividade_ritualistica" 0 %}'.replace('0', eventoId);
                }
                
                // Carregar detalhes do evento via AJAX
                fetch(`/atividades/api/evento/${eventoId}/?tipo=${tipoEvento}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Renderizar detalhes do evento
                            if (tipoEvento === 'academica') {
                                modalBody.innerHTML = `
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>Nome:</strong> ${data.evento.nome}</p>
                                            <p><strong>Tipo:</strong> ${data.evento.tipo_display}</p>
                                            <p><strong>Status:</strong> <span class="badge ${getStatusBadgeClass(data.evento.status)}">${data.evento.status_display}</span></p>
                                            <p><strong>Responsável:</strong> ${data.evento.responsavel || 'Não informado'}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>Data de Início:</strong> ${data.evento.data_inicio}</p>
                                            <p><strong>Data de Término:</strong> ${data.evento.data_fim || 'Não definida'}</p>
                                            <p><strong>Local:</strong> ${data.evento.local || 'Não informado'}</p>
                                            <p><strong>Turma:</strong> ${data.evento.turma}</p>
                                        </div>
                                    </div>
                                    <hr>
                                    <div>
                                        <h6>Descrição:</h6>
                                        <p>${data.evento.descricao || 'Sem descrição'}</p>
                                    </div>
                                `;
                            } else {
                                modalBody.innerHTML = `
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>Nome:</strong> ${data.evento.nome}</p>
                                            <p><strong>Data:</strong> ${data.evento.data}</p>
                                            <p><strong>Horário:</strong> ${data.evento.hora_inicio} - ${data.evento.hora_fim}</p>
                                            <p><strong>Local:</strong> ${data.evento.local}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>Turma:</strong> ${data.evento.turma}</p>
                                            <p><strong>Total de Participantes:</strong> ${data.evento.total_participantes}</p>
                                        </div>
                                    </div>
                                    <hr>
                                    <div>
                                        <h6>Descrição:</h6>
                                        <p>${data.evento.descricao || 'Sem descrição'}</p>
                                    </div>
                                `;
                            }
                        } else {
                            modalBody.innerHTML = `<div class="alert alert-danger">Erro ao carregar detalhes: ${data.error}</div>`;
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao carregar detalhes do evento:', error);
                        modalBody.innerHTML = `<div class="alert alert-danger">Erro ao carregar detalhes do evento.</div>`;
                    });
                
                modal.show();
            },
            eventClassNames: function(arg) {
                const classes = [];
                
                // Adicionar classe baseada no tipo de atividade
                if (arg.event.extendedProps.tipo === 'academica') {
                    classes.push('academica-event');
                } else {
                    classes.push('ritualistica-event');
                }
                
                // Adicionar classe baseada no status (apenas para atividades acadêmicas)
                if (arg.event.extendedProps.status) {
                    classes.push(arg.event.extendedProps.status + '-event');
                }
                
                return classes;
            }
        });
        
        calendar.render();
        
        // Função auxiliar para obter classe CSS do badge de status
        function getStatusBadgeClass(status) {
            switch (status) {
                case 'agendada': return 'bg-warning';
                case 'em_andamento': return 'bg-info';
                case 'concluida': return 'bg-success';
                case 'cancelada': return 'bg-secondary';
                default: return 'bg-secondary';
            }
        }
        
        // Atualizar calendário quando os filtros mudarem
        document.getElementById('filtro-tipo').addEventListener('change', function() {
            calendar.refetchEvents();
        });
        
        document.getElementById('filtro-turma').addEventListener('change', function() {
            calendar.refetchEvents();
        });
        
        document.getElementById('mostrar-concluidas').addEventListener('change', function() {
            calendar.refetchEvents();
        });
    });
</script>
{% endblock %}