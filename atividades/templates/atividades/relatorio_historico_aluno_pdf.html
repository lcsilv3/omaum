<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Relatório Histórico de Participação do Aluno</title>
  <style>
    @page {
      size: A4 portrait;
      margin: 1.5cm;
      @bottom-right {
        content: "Página " counter(page) " de " counter(pages);
        font-size: 9pt;
        color: #555;
      }
    }
    body {
      font-family: 'Helvetica', 'Arial', sans-serif;
      font-size: 9pt;
      color: #333;
    }
    .report-header {
      margin-bottom: 0.5cm;
    }
    .report-header .org-title {
      font-size: 12pt;
      font-weight: bold;
      margin: 0;
      text-align: center;
    }
    .report-header .org-meta {
      display: flex;
      align-items: center;
      width: 100%;
      margin-top: 2px;
    }
    .report-header .org-meta .org-subtitle {
      font-size: 10pt;
      margin: 0;
      text-align: center;
      flex: 1;
    }
    .report-header .org-meta .emission-datetime {
      font-size: 9pt;
      margin: 0;
      text-align: right;
      margin-left: auto;
    }
    h1 {
      text-align: center;
      font-size: 16pt;
      margin-top: 0;
      margin-bottom: 0.8cm;
      border-bottom: 1px solid #ccc;
      padding-bottom: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      page-break-inside: auto;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: left;
      vertical-align: top;
      word-wrap: break-word;
    }
    thead {
      background-color: #f2f2f2;
      display: table-header-group;
    }
    tr {
      page-break-inside: avoid;
      page-break-after: auto;
    }
    tbody tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    .summary {
      margin-top: 0.8cm;
      font-size: 10pt;
    }
    .summary ul {
      padding-left: 18px;
      margin: 0;
    }
    .summary li {
      margin-bottom: 4px;
    }
    .filters {
      margin-bottom: 0.6cm;
      font-size: 9pt;
    }
    .filters table {
      border: none;
    }
    .filters th, .filters td {
      border: none;
      padding: 2px 6px;
    }
    .filters th {
      text-align: right;
      color: #555;
      width: 140px;
    }
  </style>
</head>
<body>
  <div class="report-header">
    <p class="org-title">{{ nome_organizacao|default:"OMAUM - Ordem Mística de Aspiração Universal ao Mestrado" }}</p>
    <div class="org-meta">
      <p class="org-subtitle">{{ nome_sistema|default:"Sistema de Gestão Integrada" }}</p>
      <p class="emission-datetime">
        Data de Emissão:
        {% if data_emissao %}
          {{ data_emissao }}
        {% else %}
          {% now "d/m/Y H:i" %}
        {% endif %}
      </p>
    </div>
  </div>

  <h1>Relatório Histórico de Participação do Aluno</h1>

  <div class="filters">
    <table>
      <tbody>
        <tr>
          <th>Aluno:</th>
          <td>{{ descricao_filtros.aluno|default:"--" }}</td>
          <th>Curso:</th>
          <td>{{ descricao_filtros.curso|default:"Todos" }}</td>
        </tr>
        <tr>
          <th>Papel:</th>
          <td>{{ descricao_filtros.papel|default:"Todos" }}</td>
          <th>Período:</th>
          <td>{{ descricao_filtros.periodo|default:"Sem restrições" }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="summary">
    <strong>Resumo Consolidado</strong>
    <ul>
      <li>Total de eventos: {{ relatorio.resumo.total_eventos }}</li>
      <li>Participações contabilizadas: {{ relatorio.resumo.total_participacoes }}</li>
      <li>Presenças: {{ relatorio.resumo.total_presencas }} · Faltas: {{ relatorio.resumo.total_faltas }} (Justificadas: {{ relatorio.resumo.total_justificadas }})</li>
      <li>Atuações voluntárias: {{ relatorio.resumo.total_voluntarios }} · Atuação em instrução: {{ relatorio.resumo.total_instrucao }}</li>
      <li>
        Distribuição por papel:
        {% if relatorio.resumo.eventos_por_papel %}
          {% for papel, quantidade in relatorio.resumo.eventos_por_papel.items %}
            {{ papel }}: {{ quantidade }}{% if not forloop.last %}; {% endif %}
          {% endfor %}
        {% else %}
          sem registros
        {% endif %}
      </li>
    </ul>
  </div>

  <table>
    <thead>
      <tr>
        <th>Data</th>
        <th>Papel</th>
        <th>Descrição</th>
        <th>Atividade</th>
        <th>Curso</th>
        <th>Turma</th>
        <th>Status de Presença</th>
        <th>Status da Atividade</th>
        <th>Tipo de Atividade</th>
      </tr>
    </thead>
    <tbody>
      {% for evento in relatorio.eventos %}
      <tr>
        <td>{% if evento.data %}{{ evento.data|date:"d/m/Y" }}{% else %}-{% endif %}</td>
        <td>{{ evento.papel_display }}</td>
        <td>{{ evento.descricao }}</td>
        <td>{{ evento.atividade_nome|default:"-" }}</td>
        <td>{{ evento.curso_nome|default:"-" }}</td>
        <td>{{ evento.turma_nome|default:"-" }}</td>
        <td>{{ evento.status_presenca|default:"-" }}</td>
        <td>{{ evento.status_atividade|default:"-" }}</td>
        <td>{{ evento.tipo_atividade|default:"-" }}</td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="9" style="text-align: center;">Nenhum dado encontrado para os filtros informados.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</body>
</html>
