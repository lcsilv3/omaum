<form method="post" enctype="multipart/form-data" novalidate>
    {% csrf_token %}
    <div class="mb-3">
        <label for="id_nome" class="form-label">Nome da Atividade</label>
        {{ form.nome }}
        {% for error in form.nome.errors %}
            <div class="text-danger">{{ error }}</div>
        {% endfor %}
    </div>
    <div class="mb-3">
        <label for="id_descricao" class="form-label">Descrição</label>
        {{ form.descricao }}
        {% for error in form.descricao.errors %}
            <div class="text-danger">{{ error }}</div>
        {% endfor %}
    </div>
    <div class="mb-3">
        <label for="id_tipo_atividade" class="form-label">Tipo de Atividade</label>
        {{ form.tipo_atividade }}
        {% for error in form.tipo_atividade.errors %}
            <div class="text-danger">{{ error }}</div>
        {% endfor %}
    </div>
    <div class="mb-3">
        <label for="id_status" class="form-label">Status</label>
        {{ form.status }}
        {% for error in form.status.errors %}
            <div class="text-danger">{{ error }}</div>
        {% endfor %}
    </div>
    <div class="mb-3">
        <label for="id_data_inicio" class="form-label">Data de Início</label>
        {{ form.data_inicio }}
        {% for error in form.data_inicio.errors %}
            <div class="text-danger">{{ error }}</div>
        {% endfor %}
    </div>
    <div class="mb-3">
        <label for="id_data_fim" class="form-label">Data de Término</label>
        {{ form.data_fim }}
        {% for error in form.data_fim.errors %}
            <div class="text-danger">{{ error }}</div>
        {% endfor %}
        <small class="form-text text-muted">Opcional. Se não informada, será considerada a mesma data de início.</small>
    </div>
    <div class="mb-3">
        <label for="id_hora_inicio" class="form-label">Hora de Início</label>
        {{ form.hora_inicio }}
        {% for error in form.hora_inicio.errors %}
            <div class="text-danger">{{ error }}</div>
        {% endfor %}
    </div>
    <div class="mb-3">
        <label for="id_hora_fim" class="form-label">Hora de Término</label>
        {{ form.hora_fim }}
        {% for error in form.hora_fim.errors %}
            <div class="text-danger">{{ error }}</div>
        {% endfor %}
        <small class="form-text text-muted">Opcional. Se não informada, será considerada 1 hora após o início.</small>
    </div>
    <div class="mb-3">
        <label for="id_local" class="form-label">Local</label>
        {{ form.local }}
        {% for error in form.local.errors %}
            <div class="text-danger">{{ error }}</div>
        {% endfor %}
    </div>
    <div class="mb-3">
        <label for="id_responsavel" class="form-label">Responsável</label>
        {{ form.responsavel }}
        {% for error in form.responsavel.errors %}
            <div class="text-danger">{{ error }}</div>
        {% endfor %}
    </div>
    <div class="mb-3">
        <label for="id_curso" class="form-label">Curso</label>
        {{ form.curso }}
        {% for error in form.curso.errors %}
            <div class="text-danger">{{ error }}</div>
        {% endfor %}
    </div>
    <div class="mb-3">
        <label for="id_turmas" class="form-label">Turmas</label>
        <div class="d-flex align-items-center mb-2">
            <input type="checkbox" id="select-all-turmas" class="form-check-input me-2">
            <label for="select-all-turmas" class="form-check-label">Selecionar todas as turmas</label>
        </div>
        {{ form.turmas }}
        {% for error in form.turmas.errors %}
            <div class="text-danger">{{ error }}</div>
        {% endfor %}
        <small class="form-text text-muted">Selecione uma ou mais(CTRL) turmas para esta atividade.</small>
    </div>
    <div class="mb-3 form-check">
        {{ form.convocacao }}
        <label class="form-check-label" for="id_convocacao">Convocação</label>
        {% for error in form.convocacao.errors %}
            <div class="text-danger">{{ error }}</div>
        {% endfor %}
    </div>
    <div class="d-flex justify-content-between mb-4">
        <a href="{% url 'atividades:listar_atividades' %}" class="btn btn-secondary">
            <i class="fas fa-times"></i> Cancelar
        </a>
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> Criar Atividade
        </button>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const cursoSelect = document.getElementById('id_curso');
    const turmasSelect = document.getElementById('id_turmas');
    const selectAllTurmas = document.getElementById('select-all-turmas');
    let noTurmasMsg = document.getElementById('no-turmas-msg');
    if (!noTurmasMsg) {
        noTurmasMsg = document.createElement('div');
        noTurmasMsg.id = 'no-turmas-msg';
        noTurmasMsg.className = 'text-muted mt-2';
        turmasSelect.parentNode.appendChild(noTurmasMsg);
    }

    let todasTurmas = []; // Armazenar todas as turmas carregadas

    function carregarTodasTurmas() {
        fetch(`/atividades/ajax/turmas-por-curso/`) // Sem parâmetro curso carrega todas
            .then(response => response.json())
            .then(data => {
                todasTurmas = data.turmas || [];
                atualizarTurmasDisplay();
            })
            .catch(error => {
                console.error('Erro ao carregar turmas:', error);
                noTurmasMsg.textContent = 'Erro ao carregar turmas.';
            });
    }

    function atualizarTurmasDisplay(cursoId = null, turmasSelecionadas = []) {
        turmasSelect.innerHTML = '';
        
        let turmasFiltradas = todasTurmas;
        if (cursoId) {
            turmasFiltradas = todasTurmas.filter(turma => turma.curso_id == cursoId);
        }

        if (turmasFiltradas.length === 0) {
            if (cursoId) {
                noTurmasMsg.textContent = 'Não há turmas para este curso.';
            } else {
                noTurmasMsg.textContent = 'Nenhuma turma cadastrada.';
            }
        } else {
            noTurmasMsg.textContent = '';
            turmasFiltradas.forEach(function(turma) {
                const option = document.createElement('option');
                option.value = turma.id;
                option.textContent = turma.nome;
                if (turmasSelecionadas.includes(String(turma.id))) {
                    option.selected = true;
                }
                turmasSelect.appendChild(option);
            });
        }
    }

    function atualizarTurmas(cursoId, turmasSelecionadas=[]) {
        atualizarTurmasDisplay(cursoId, turmasSelecionadas);
    }

    if (cursoSelect) {
        cursoSelect.addEventListener('change', function() {
            atualizarTurmas(this.value);
        });
    }

    // Carregar todas as turmas na inicialização
    if (turmasSelect) {
        carregarTodasTurmas();
        
        // Se há um curso pré-selecionado, aplicar o filtro após carregar as turmas
        if (cursoSelect && cursoSelect.value) {
            const turmasSelecionadas = Array.from(turmasSelect.selectedOptions).map(opt => opt.value);
            // Aguardar o carregamento das turmas antes de filtrar
            setTimeout(() => {
                atualizarTurmas(cursoSelect.value, turmasSelecionadas);
            }, 100);
        }
    }

    if (selectAllTurmas && turmasSelect) {
        selectAllTurmas.addEventListener('change', function() {
            for (let option of turmasSelect.options) {
                option.selected = this.checked;
            }
        });
        turmasSelect.addEventListener('change', function() {
            selectAllTurmas.checked = Array.from(turmasSelect.options).every(opt => opt.selected);
        });
    }
});
</script>

{% comment %}
Returns:
    dict: Dicionário com todos os modelos necessários
Raises:
    ImportError: Se algum módulo não puder ser importado
    AttributeError: Se algum modelo não for encontrado no módulo
"""
try:
    atividades_module = import_module("atividades.models")
    cursos_module = import_module("cursos.models")
    turmas_module = import_module("turmas.models")
    alunos_module = import_module("alunos.models")

    return {
        'AtividadeAcademica': getattr(atividades_module, "AtividadeAcademica"),
        'AtividadeRitualistica': getattr(atividades_module, "AtividadeRitualistica"),
        'Curso': getattr(cursos_module, "Curso"),
        'Turma': getattr(turmas_module, "Turma"),
        'Aluno': getattr(alunos_module, "Aluno"),
    }
except (ImportError, AttributeError) as e:
    logger.error("Erro ao obter modelos: %s", e)
    raise
{% endcomment %}