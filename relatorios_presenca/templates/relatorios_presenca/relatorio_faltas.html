
{% extends 'base.html' %}
{% block title %}Relatório de Faltas{% endblock %}
{% block content %}
<div class="container mt-4">
  <h2>Relatório de Faltas</h2>
  <hr>
  <form id="filtroFaltasForm" method="get" class="mb-4">
    <div class="form-row">
      <div class="form-group col-md-4">
        <label for="turma_id">Turma</label>
        <select id="turma_id" name="turma_id" class="form-control">
          <option value="">Todas</option>
          {% for turma in turmas %}
            <option value="{{ turma.id }}" {% if turma.id|stringformat:'s' == request.GET.turma_id %}selected{% endif %}>{{ turma.nome }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group col-md-3">
        <label for="data_inicio">Data Início</label>
        <input type="date" id="data_inicio" name="data_inicio" class="form-control" value="{{ request.GET.data_inicio }}">
      </div>
      <div class="form-group col-md-3">
        <label for="data_fim">Data Fim</label>
        <input type="date" id="data_fim" name="data_fim" class="form-control" value="{{ request.GET.data_fim }}">
      </div>
      <div class="form-group col-md-2 align-self-end d-flex flex-column">
        <button type="button" id="btnBuscarFaltas" class="btn btn-primary mb-2" aria-label="Buscar">Buscar</button>
        <button type="button" id="btnExportarCSVFaltas" class="btn btn-success mb-2" aria-label="Exportar CSV">Exportar CSV</button>
        <button type="button" id="btnExportarPDFFaltas" class="btn btn-danger" aria-label="Exportar PDF">Exportar PDF</button>
      </div>
    </div>
  </form>

  <div id="tabela-faltas">
    {% include 'relatorios_presenca/partials/_relatorio_faltas_tabela.html' with resultados=resultados filtros_aplicados=filtros_aplicados %}
  </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('filtroFaltasForm');
  const btnBuscar = document.getElementById('btnBuscarFaltas');
  const btnExportarCSV = document.getElementById('btnExportarCSVFaltas');
  const btnExportarPDF = document.getElementById('btnExportarPDFFaltas');
  const tabela = document.getElementById('tabela-faltas');

  const toggleExportButtons = (enabled) => {
    if (btnExportarCSV) btnExportarCSV.disabled = !enabled;
    if (btnExportarPDF) btnExportarPDF.disabled = !enabled;
  };

  const hasResultados = () => {
    const wrapper = tabela.querySelector('[data-resultados]');
    return wrapper && wrapper.getAttribute('data-resultados') === '1';
  };

  function montarQueryString() {
    const params = new URLSearchParams(new FormData(form));
    return params.toString();
  }

  btnBuscar.addEventListener('click', function() {
    tabela.innerHTML = '<div class="text-center my-3"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div><div>Carregando...</div></div>';
    const params = new URLSearchParams(new FormData(form));
    params.append('partial', '1');
    fetch(window.location.pathname + '?' + params.toString(), {
      credentials: 'same-origin',
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
      .then(r => r.text())
      .then(html => {
        tabela.innerHTML = html;
        toggleExportButtons(hasResultados());
      })
      .catch(() => {
        tabela.innerHTML = '<div class="alert alert-danger">Erro ao buscar resultados.</div>';
        toggleExportButtons(false);
      });
  });

  btnExportarCSV.addEventListener('click', function() {
    if (!hasResultados()) {
      alert('Busque os dados antes de exportar.');
      return;
    }
    const url = window.location.pathname + '?' + montarQueryString() + '&formato=csv';
    window.open(url, '_blank');
  });
  btnExportarPDF.addEventListener('click', function() {
    if (!hasResultados()) {
      alert('Busque os dados antes de exportar.');
      return;
    }
    const url = window.location.pathname + '?' + montarQueryString() + '&formato=pdf';
    window.open(url, '_blank');
  });

  toggleExportButtons(hasResultados());
});
</script>
</div>
{% endblock %}
