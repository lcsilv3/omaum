{% if sucesso and correlacoes %}
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>Aluno</th>
                <th class="text-center">% Presença</th>
                <th class="text-center">Nota Estimada</th>
                <th class="text-center">Carências</th>
                <th class="text-center">Classificação</th>
                <th>Análise</th>
            </tr>
        </thead>
        <tbody>
            {% for item in correlacoes %}
            <tr class="
                {% if item.classificacao == 'ALTA_PERFORMANCE' %}correlacao-forte
                {% elif item.classificacao == 'BOA_PERFORMANCE' %}correlacao-forte
                {% elif item.classificacao == 'PERFORMANCE_REGULAR' %}correlacao-moderada
                {% elif item.classificacao == 'BAIXA_PERFORMANCE' %}correlacao-fraca
                {% elif 'DIVERGENTE' in item.classificacao %}table-warning
                {% endif %}">
                <td>
                    <strong>{{ item.aluno_nome }}</strong>
                </td>
                <td class="text-center">
                    <span class="
                        {% if item.percentual_presenca >= 85 %}performance-alta
                        {% elif item.percentual_presenca >= 75 %}performance-boa
                        {% elif item.percentual_presenca >= 60 %}performance-regular
                        {% else %}performance-baixa
                        {% endif %}">
                        {{ item.percentual_presenca }}%
                    </span>
                </td>
                <td class="text-center">
                    <span class="
                        {% if item.nota_estimada >= 8 %}performance-alta
                        {% elif item.nota_estimada >= 7 %}performance-boa
                        {% elif item.nota_estimada >= 6 %}performance-regular
                        {% else %}performance-baixa
                        {% endif %}">
                        {{ item.nota_estimada }}
                    </span>
                </td>
                <td class="text-center">
                    <span class="badge bg-secondary">{{ item.carencias }}</span>
                </td>
                <td class="text-center">
                    {% if item.classificacao == 'ALTA_PERFORMANCE' %}
                        <span class="badge bg-success">Alta Performance</span>
                    {% elif item.classificacao == 'BOA_PERFORMANCE' %}
                        <span class="badge bg-success">Boa Performance</span>
                    {% elif item.classificacao == 'PERFORMANCE_REGULAR' %}
                        <span class="badge bg-warning">Performance Regular</span>
                    {% elif item.classificacao == 'BAIXA_PERFORMANCE' %}
                        <span class="badge bg-danger">Baixa Performance</span>
                    {% elif item.classificacao == 'DIVERGENTE_ALTA_PRESENCA' %}
                        <span class="badge bg-warning">Divergente: Alta Presença</span>
                    {% elif item.classificacao == 'DIVERGENTE_BAIXA_PRESENCA' %}
                        <span class="badge bg-info">Divergente: Baixa Presença</span>
                    {% else %}
                        <span class="badge bg-secondary">Indefinida</span>
                    {% endif %}
                </td>
                <td>
                    {% if item.classificacao == 'ALTA_PERFORMANCE' %}
                        <small class="text-success">
                            <i class="fas fa-star"></i> Correlação perfeita entre presença e desempenho
                        </small>
                    {% elif item.classificacao == 'BOA_PERFORMANCE' %}
                        <small class="text-success">
                            <i class="fas fa-thumbs-up"></i> Boa correlação - continuar monitoramento
                        </small>
                    {% elif item.classificacao == 'PERFORMANCE_REGULAR' %}
                        <small class="text-warning">
                            <i class="fas fa-balance-scale"></i> Performance estável - pode melhorar
                        </small>
                    {% elif item.classificacao == 'BAIXA_PERFORMANCE' %}
                        <small class="text-danger">
                            <i class="fas fa-exclamation-triangle"></i> Baixa correlação - intervenção necessária
                        </small>
                    {% elif item.classificacao == 'DIVERGENTE_ALTA_PRESENCA' %}
                        <small class="text-warning">
                            <i class="fas fa-question-circle"></i> Alta presença, baixo desempenho - investigar
                        </small>
                    {% elif item.classificacao == 'DIVERGENTE_BAIXA_PRESENCA' %}
                        <small class="text-info">
                            <i class="fas fa-lightbulb"></i> Baixa presença, alto desempenho - caso especial
                        </small>
                    {% else %}
                        <small class="text-muted">
                            <i class="fas fa-search"></i> Padrão indefinido - análise adicional
                        </small>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Análise Estatística Detalhada -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-chart-pie"></i> Distribuição de Performance</h6>
            </div>
            <div class="card-body">
                {% with alta=0 boa=0 regular=0 baixa=0 %}
                    {% for item in correlacoes %}
                        {% if item.classificacao == 'ALTA_PERFORMANCE' %}
                            {% with alta=alta|add:1 %}{% endwith %}
                        {% elif item.classificacao == 'BOA_PERFORMANCE' %}
                            {% with boa=boa|add:1 %}{% endwith %}
                        {% elif item.classificacao == 'PERFORMANCE_REGULAR' %}
                            {% with regular=regular|add:1 %}{% endwith %}
                        {% elif item.classificacao == 'BAIXA_PERFORMANCE' %}
                            {% with baixa=baixa|add:1 %}{% endwith %}
                        {% endif %}
                    {% endfor %}
                    
                    <div class="row text-center">
                        <div class="col-6 mb-2">
                            <div class="card border-success">
                                <div class="card-body p-2">
                                    <h6 class="text-success mb-1">
                                        {% for item in correlacoes %}{% if item.classificacao == 'ALTA_PERFORMANCE' %}{{ forloop.counter0|add:1 }}{% endif %}{% endfor %}
                                    </h6>
                                    <small>Alta Performance</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 mb-2">
                            <div class="card border-info">
                                <div class="card-body p-2">
                                    <h6 class="text-info mb-1">
                                        {% for item in correlacoes %}{% if item.classificacao == 'BOA_PERFORMANCE' %}{{ forloop.counter0|add:1 }}{% endif %}{% endfor %}
                                    </h6>
                                    <small>Boa Performance</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card border-warning">
                                <div class="card-body p-2">
                                    <h6 class="text-warning mb-1">
                                        {% for item in correlacoes %}{% if item.classificacao == 'PERFORMANCE_REGULAR' %}{{ forloop.counter0|add:1 }}{% endif %}{% endfor %}
                                    </h6>
                                    <small>Regular</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card border-danger">
                                <div class="card-body p-2">
                                    <h6 class="text-danger mb-1">
                                        {% for item in correlacoes %}{% if item.classificacao == 'BAIXA_PERFORMANCE' %}{{ forloop.counter0|add:1 }}{% endif %}{% endfor %}
                                    </h6>
                                    <small>Baixa Performance</small>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endwith %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Casos Divergentes</h6>
            </div>
            <div class="card-body">
                {% with divergente_alta=0 divergente_baixa=0 %}
                    {% for item in correlacoes %}
                        {% if item.classificacao == 'DIVERGENTE_ALTA_PRESENCA' %}
                            {% with divergente_alta=divergente_alta|add:1 %}{% endwith %}
                        {% elif item.classificacao == 'DIVERGENTE_BAIXA_PRESENCA' %}
                            {% with divergente_baixa=divergente_baixa|add:1 %}{% endwith %}
                        {% endif %}
                    {% endfor %}
                    
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="card border-warning">
                                <div class="card-body p-2">
                                    <h6 class="text-warning mb-1">
                                        {% for item in correlacoes %}{% if item.classificacao == 'DIVERGENTE_ALTA_PRESENCA' %}{{ forloop.counter0|add:1 }}{% endif %}{% endfor %}
                                    </h6>
                                    <small>Alta Presença<br>Baixo Desempenho</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card border-info">
                                <div class="card-body p-2">
                                    <h6 class="text-info mb-1">
                                        {% for item in correlacoes %}{% if item.classificacao == 'DIVERGENTE_BAIXA_PRESENCA' %}{{ forloop.counter0|add:1 }}{% endif %}{% endfor %}
                                    </h6>
                                    <small>Baixa Presença<br>Alto Desempenho</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i>
                            Casos divergentes requerem análise individual para identificar fatores específicos.
                        </small>
                    </div>
                {% endwith %}
            </div>
        </div>
    </div>
</div>

<!-- Interpretação da Correlação -->
<div class="row mt-3">
    <div class="col-12">
        <div class="card bg-light">
            <div class="card-body">
                <h6><i class="fas fa-calculator"></i> Interpretação Estatística</h6>
                {% if estatisticas.coeficiente_correlacao >= 0.8 %}
                    <p class="text-success mb-2">
                        <strong>Correlação Muito Forte (r = {{ estatisticas.coeficiente_correlacao }})</strong><br>
                        Existe uma relação muito forte entre presença e desempenho. A política de frequência está sendo efetiva.
                    </p>
                {% elif estatisticas.coeficiente_correlacao >= 0.6 %}
                    <p class="text-success mb-2">
                        <strong>Correlação Forte (r = {{ estatisticas.coeficiente_correlacao }})</strong><br>
                        Há uma relação significativa entre presença e desempenho. Manter foco no controle de frequência.
                    </p>
                {% elif estatisticas.coeficiente_correlacao >= 0.4 %}
                    <p class="text-warning mb-2">
                        <strong>Correlação Moderada (r = {{ estatisticas.coeficiente_correlacao }})</strong><br>
                        A relação existe mas pode ser fortalecida. Investigar outros fatores que influenciam o desempenho.
                    </p>
                {% else %}
                    <p class="text-danger mb-2">
                        <strong>Correlação Fraca (r = {{ estatisticas.coeficiente_correlacao }})</strong><br>
                        Baixa correlação entre presença e desempenho. Revisar estratégias pedagógicas e de avaliação.
                    </p>
                {% endif %}
                
                <small class="text-muted">
                    Análise baseada em {{ estatisticas.total_analisados }} alunos | 
                    Média de Presença: {{ estatisticas.media_presenca }}% | 
                    Média de Desempenho: {{ estatisticas.media_desempenho }}
                </small>
            </div>
        </div>
    </div>
</div>

{% elif not sucesso %}
<div class="alert alert-warning">
    <i class="fas fa-exclamation-triangle"></i>
    <strong>Erro na análise de correlação:</strong>
    {{ estatisticas.erro|default:"Erro desconhecido no processamento dos dados de correlação." }}
</div>
{% else %}
<div class="alert alert-info text-center">
    <i class="fas fa-info-circle"></i>
    <strong>Nenhum dado disponível para análise</strong>
    <br>
    <small>Não há dados suficientes para calcular a correlação entre presença e desempenho.</small>
</div>
{% endif %}
