{% extends "base.html" %}
{% load static %}

{% block title %}{{ titulo }}{% endblock %}

{% block head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .coordenacao-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .stat-card { transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .performance-excelente { border-left: 4px solid #4caf50; background-color: #e8f5e8; }
        .performance-bom { border-left: 4px solid #2196f3; background-color: #e3f2fd; }
        .performance-atencao { border-left: 4px solid #ff9800; background-color: #fff3e0; }
        .performance-critico { border-left: 4px solid #f44336; background-color: #ffebee; }
        .alerta-coordenacao { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Cabeçalho da Coordenação -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card coordenacao-header">
                <div class="card-body">
                    <h4><i class="fas fa-users-cog"></i> {{ titulo }}</h4>
                    <p class="mb-0">Painel executivo para gestão acadêmica e acompanhamento de turmas</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros Dinâmicos -->
    <div class="card mb-4">
        <div class="card-header">
            <h5><i class="fas fa-filter"></i> Filtros de Análise</h5>
        </div>
        <div class="card-body">
            <form id="filtroForm" class="row g-3">
                <div class="col-md-3">
                    <label for="curso_id" class="form-label">Curso:</label>
                    <select id="curso_id" name="curso_id" class="form-select">
                        <option value="">Todos os cursos</option>
                        <option value="1">Administração</option>
                        <option value="2">Engenharia</option>
                        <option value="3">Direito</option>
                        <option value="4">Medicina</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="turma_id" class="form-label">Turma:</label>
                    <select id="turma_id" name="turma_id" class="form-select">
                        <option value="">Todas as turmas</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="periodo" class="form-label">Período de Análise:</label>
                    <select id="periodo" name="periodo" class="form-select">
                        <option value="trimestre">Trimestre</option>
                        <option value="semestre" selected>Semestre</option>
                        <option value="ano">Ano</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button type="button" id="btnFiltrar" class="btn btn-primary" style="margin-top: 32px;">
                        <i class="fas fa-search"></i> Aplicar Filtros
                    </button>
                    <a href="{% url 'exportar_csv_dashboard_coordenacao' %}" class="btn btn-success" id="btnExportar" style="margin-top: 32px;">
                        <i class="fas fa-download"></i> CSV
                    </a>
                </div>
            </form>
        </div>
    </div>

    {% if erro %}
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i> {{ erro }}
        </div>
    {% else %}
        <!-- Estatísticas Gerais da Coordenação -->
        {% if estatisticas_gerais %}
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stat-card text-center">
                    <div class="card-body">
                        <i class="fas fa-users fa-2x text-primary mb-2"></i>
                        <h3>{{ estatisticas_gerais.total_alunos|default:0 }}</h3>
                        <p class="mb-0">Total de Alunos</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card text-center">
                    <div class="card-body">
                        <i class="fas fa-chalkboard-teacher fa-2x text-success mb-2"></i>
                        <h3>{{ estatisticas_gerais.total_turmas|default:0 }}</h3>
                        <p class="mb-0">Total de Turmas</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card text-center">
                    <div class="card-body">
                        <i class="fas fa-chart-line fa-2x text-info mb-2"></i>
                        <h3>{{ estatisticas_gerais.presenca_media|default:0 }}%</h3>
                        <p class="mb-0">Presença Média</p>
                        {% if estatisticas_gerais.tendencia_presenca %}
                            <small class="{% if estatisticas_gerais.tendencia_presenca > 0 %}text-success{% else %}text-danger{% endif %}">
                                {% if estatisticas_gerais.tendencia_presenca > 0 %}↗{% else %}↘{% endif %}
                                {{ estatisticas_gerais.tendencia_presenca|floatformat:1 }}%
                            </small>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card text-center">
                    <div class="card-body">
                        <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                        <h3>{{ estatisticas_gerais.total_carencias|default:0 }}</h3>
                        <p class="mb-0">Total Carências</p>
                        <small class="text-muted">Média: {{ estatisticas_gerais.carencias_media|default:0 }}/aluno</small>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Distribuição de Performance -->
        {% if distribuicao_performance %}
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card performance-excelente text-center">
                    <div class="card-body">
                        <h3>{{ distribuicao_performance.excelente|default:0 }}</h3>
                        <p class="mb-0">Excelente (≥90%)</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card performance-bom text-center">
                    <div class="card-body">
                        <h3>{{ distribuicao_performance.bom|default:0 }}</h3>
                        <p class="mb-0">Bom (75-89%)</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card performance-atencao text-center">
                    <div class="card-body">
                        <h3>{{ distribuicao_performance.atencao|default:0 }}</h3>
                        <p class="mb-0">Atenção (60-74%)</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card performance-critico text-center">
                    <div class="card-body">
                        <h3>{{ distribuicao_performance.critico|default:0 }}</h3>
                        <p class="mb-0">Crítico (<60%)</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Gráfico de Performance das Turmas -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-chart-bar"></i> Performance das Turmas</h5>
            </div>
            <div class="card-body">
                <canvas id="chartTurmas" width="400" height="150"></canvas>
            </div>
        </div>

        <!-- Top 5 Melhores e Piores Turmas -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5><i class="fas fa-trophy"></i> Top 5 Melhores Turmas</h5>
                    </div>
                    <div class="card-body">
                        {% if melhores_turmas %}
                            {% for turma in melhores_turmas %}
                            <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                                <div>
                                    <strong>{{ turma.turma__nome }}</strong><br>
                                    <small class="text-muted">{{ turma.turma__curso__nome }}</small>
                                </div>
                                <span class="badge bg-success">{{ turma.percentual_presenca|floatformat:1 }}%</span>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">Nenhum dado disponível</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h5><i class="fas fa-exclamation-triangle"></i> Top 5 Turmas em Atenção</h5>
                    </div>
                    <div class="card-body">
                        {% if piores_turmas %}
                            {% for turma in piores_turmas %}
                            <div class="d-flex justify-content-between align-items-center border-bottom py-2 alerta-coordenacao">
                                <div>
                                    <strong>{{ turma.turma__nome }}</strong><br>
                                    <small class="text-muted">{{ turma.turma__curso__nome }}</small>
                                </div>
                                <span class="badge bg-danger">{{ turma.percentual_presenca|floatformat:1 }}%</span>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">Nenhuma turma em situação crítica</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Alunos que Requerem Atenção -->
        {% if alunos_atencao %}
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5><i class="fas fa-users"></i> Alunos que Requerem Atenção (≥5 carências)</h5>
            </div>
            <div class="card-body">
                <div id="conteudoAlunos">
                    {% include "presencas/partials/tabela_alunos_atencao.html" %}
                </div>
            </div>
        </div>
        {% endif %}
    {% endif %}
</div>

<script src="{% static 'presencas/js/filtros_dinamicos.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Configurar filtros
    configurarFiltros({
        endpointTurmas: '{% url "ajax_turmas" %}',
        endpointAnos: '{% url "ajax_anos" %}',
        endpointFiltro: '{% url "filtrar_dashboard_coordenacao" %}',
        templateTabela: 'presencas/partials/tabela_alunos_atencao.html'
    });

    // Gráfico de performance das turmas
    {% if dados_turmas %}
    const ctx = document.getElementById('chartTurmas').getContext('2d');
    
    const turmasData = [
        {% for turma in dados_turmas|slice:":10" %}
        {
            nome: '{{ turma.turma__nome|escapejs }}',
            presenca: {{ turma.percentual_presenca|default:0 }},
            alunos: {{ turma.total_alunos|default:0 }}
        },
        {% endfor %}
    ];

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: turmasData.map(t => t.nome),
            datasets: [{
                label: 'Percentual de Presença',
                data: turmasData.map(t => t.presenca),
                backgroundColor: turmasData.map(t => 
                    t.presenca >= 90 ? '#4caf50' :
                    t.presenca >= 75 ? '#2196f3' :
                    t.presenca >= 60 ? '#ff9800' : '#f44336'
                ),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: { display: true, text: 'Percentual de Presença (%)' }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        afterLabel: function(context) {
                            const turma = turmasData[context.dataIndex];
                            return `Alunos: ${turma.alunos}`;
                        }
                    }
                }
            }
        }
    });
    {% endif %}
});
</script>
{% endblock %}
