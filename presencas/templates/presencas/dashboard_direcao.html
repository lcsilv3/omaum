{% extends "base.html" %}
{% load static %}

{% block title %}{{ titulo }}{% endblock %}

{% block head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .direcao-header { background: linear-gradient(135deg, #8e2de2 0%, #4a00e0 100%); color: white; }
        .indice-card { transition: all 0.3s ease; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .indice-card:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.2); }
        .alerta-critico { border: 2px solid #f44336; animation: blink 1.5s infinite; }
        .alerta-atencao { border: 2px solid #ff9800; }
        @keyframes blink { 0%, 50% { border-color: #f44336; } 51%, 100% { border-color: transparent; } }
        .ranking-card { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); }
        .performance-badge { font-size: 1.1em; padding: 0.5rem 1rem; }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Cabeçalho da Direção -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card direcao-header">
                <div class="card-body">
                    <h4><i class="fas fa-building"></i> {{ titulo }}</h4>
                    <p class="mb-0">Painel estratégico para gestão institucional e tomada de decisões executivas</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros Estratégicos -->
    <div class="card mb-4">
        <div class="card-header">
            <h5><i class="fas fa-filter"></i> Filtros Estratégicos</h5>
        </div>
        <div class="card-body">
            <form id="filtroForm" class="row g-3">
                <div class="col-md-4">
                    <label for="curso_id" class="form-label">Curso:</label>
                    <select id="curso_id" name="curso_id" class="form-select">
                        <option value="">Todos os cursos</option>
                        <option value="1">Administração</option>
                        <option value="2">Engenharia</option>
                        <option value="3">Direito</option>
                        <option value="4">Medicina</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="ano" class="form-label">Ano de Análise:</label>
                    <select id="ano" name="ano" class="form-select">
                        <option value="2025" selected>2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <button type="button" id="btnFiltrar" class="btn btn-primary" style="margin-top: 32px;">
                        <i class="fas fa-search"></i> Aplicar Filtros
                    </button>
                    <a href="{% url 'exportar_csv_dashboard_direcao' %}" class="btn btn-success" id="btnExportar" style="margin-top: 32px;">
                        <i class="fas fa-download"></i> Relatório CSV
                    </a>
                </div>
            </form>
        </div>
    </div>

    {% if erro %}
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i> {{ erro }}
        </div>
    {% else %}
        <!-- Estatísticas Institucionais -->
        {% if estatisticas_institucionais %}
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-university fa-2x text-primary mb-2"></i>
                        <h3>{{ estatisticas_institucionais.total_alunos|default:0 }}</h3>
                        <p class="mb-0">Total de Alunos</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-graduation-cap fa-2x text-success mb-2"></i>
                        <h3>{{ estatisticas_institucionais.total_cursos|default:0 }}</h3>
                        <p class="mb-0">Cursos Ativos</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-chalkboard fa-2x text-info mb-2"></i>
                        <h3>{{ estatisticas_institucionais.total_turmas|default:0 }}</h3>
                        <p class="mb-0">Turmas Ativas</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-chart-line fa-2x text-warning mb-2"></i>
                        <h3>{{ estatisticas_institucionais.presenca_media|default:0 }}%</h3>
                        <p class="mb-0">Presença Institucional</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Índices de Performance Institucional -->
        {% if indices_performance %}
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card indice-card text-center">
                    <div class="card-body">
                        <h3>{{ indices_performance.indice_geral|default:0 }}%</h3>
                        <p class="mb-1">Índice Geral de Performance</p>
                        <span class="performance-badge badge bg-{% if indices_performance.indice_geral >= 85 %}success{% elif indices_performance.indice_geral >= 70 %}warning text-dark{% else %}danger{% endif %}">
                            {{ indices_performance.classificacao|default:"N/A" }}
                        </span>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card indice-card text-center">
                    <div class="card-body">
                        <h3>{{ indices_performance.indice_presenca|default:0 }}%</h3>
                        <p class="mb-0">Índice de Presença</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card indice-card text-center">
                    <div class="card-body">
                        <h3>{{ indices_performance.indice_qualidade|default:0 }}%</h3>
                        <p class="mb-0">Índice de Qualidade</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card indice-card text-center">
                    <div class="card-body">
                        <h3>{{ indices_performance.indice_retencao|default:0 }}%</h3>
                        <p class="mb-0">Índice de Retenção</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Alertas para Direção -->
        {% if alertas_direcao %}
        <div class="row mb-4">
            {% for alerta in alertas_direcao %}
            <div class="col-md-6 mb-3">
                <div class="card {% if alerta.tipo == 'critico' %}alerta-critico{% else %}alerta-atencao{% endif %}">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="fas fa-{% if alerta.tipo == 'critico' %}exclamation-triangle text-danger{% else %}exclamation-circle text-warning{% endif %}"></i>
                            {{ alerta.curso }}
                        </h6>
                        <p class="card-text">{{ alerta.mensagem }}</p>
                        <small class="text-muted">Requer ação imediata da direção</small>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Evolução Mensal -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-chart-line"></i> Evolução Institucional (12 meses)</h5>
            </div>
            <div class="card-body">
                <canvas id="chartEvolucao" width="400" height="150"></canvas>
            </div>
        </div>

        <!-- Ranking de Cursos -->
        <div class="card mb-4">
            <div class="card-header ranking-card">
                <h5><i class="fas fa-trophy"></i> Ranking de Performance por Curso</h5>
            </div>
            <div class="card-body">
                <div id="conteudoRanking">
                    {% include "presencas/partials/ranking_cursos.html" %}
                </div>
            </div>
        </div>

        <!-- Dados Detalhados por Curso -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-table"></i> Dados Detalhados por Curso</h5>
            </div>
            <div class="card-body">
                <div id="conteudoTabela">
                    {% include "presencas/partials/tabela_cursos_direcao.html" %}
                </div>
            </div>
        </div>
    {% endif %}
</div>

<script src="{% static 'presencas/js/filtros_dinamicos.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Configurar filtros
    configurarFiltros({
        endpointTurmas: '{% url "ajax_turmas" %}',
        endpointAnos: '{% url "ajax_anos" %}',
        endpointFiltro: '{% url "filtrar_dashboard_direcao" %}',
        templateTabela: 'presencas/partials/tabela_cursos_direcao.html'
    });

    // Gráfico de evolução mensal
    {% if evolucao_mensal %}
    const ctx = document.getElementById('chartEvolucao').getContext('2d');
    
    const evolucaoData = [
        {% for item in evolucao_mensal %}
        {
            periodo: '{{ item.mes|default:"N/A" }}/{{ item.ano|default:"N/A" }}',
            presenca: {{ item.presenca_media|default:0 }},
            alunos: {{ item.total_alunos|default:0 }}
        },
        {% endfor %}
    ];

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: evolucaoData.map(e => e.periodo),
            datasets: [{
                label: 'Presença Média Institucional (%)',
                data: evolucaoData.map(e => e.presenca),
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: { display: true, text: 'Percentual de Presença (%)' }
                },
                x: {
                    title: { display: true, text: 'Período (Mês/Ano)' }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        afterLabel: function(context) {
                            const item = evolucaoData[context.dataIndex];
                            return `Total de alunos: ${item.alunos}`;
                        }
                    }
                }
            }
        }
    });
    {% endif %}
});
</script>
{% endblock %}
