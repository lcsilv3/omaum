{% extends "base.html" %}
{% load static %}
{% load i18n %}
{% load presenca_extras %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
    .collapse-toggle {
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .collapse-toggle:hover {
        opacity: 0.8;
    }
    
    .chevron {
        display: inline-block;
        transition: transform 0.3s ease;
        margin-right: 10px;
    }
    
    .collapsed .chevron {
        transform: rotate(90deg);
    }
    
    .accordion-button:focus { 
        box-shadow: 0 0 0 0.2rem #90caf9; 
    }
    
    .flatpickr-ok {
        background: #007bff;
        color: white;
        border: none;
        padding: 5px 10px;
        margin: 5px;
        cursor: pointer;
        border-radius: 3px;
    }
    
    .msg-limite-dias {
        color: #d32f2f;
        font-size: 0.98em;
        margin-top: 4px;
        display: none;
    }
    
    .obs-dia {
        font-size: 0.95em;
        margin-top: 6px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>{% trans "Registrar Presença" %}</h1>
        <div class="btn-group" role="group">
            <a href="{% url 'presencas:registrar_presenca_totais_atividades' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> {% trans "Etapa Anterior" %}
            </a>
            <a href="{% url 'presencas:listar_presencas_academicas' %}" class="btn btn-secondary">
                <i class="fas fa-home"></i> {% trans "Voltar à Lista" %}
            </a>
        </div>
    </div>
    
    <!-- Etapa 3: Designação dos Dias -->
    <div class="card">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">
                <a class="collapse-toggle text-white text-decoration-none" data-bs-toggle="collapse" href="#secao-dias-atividades" role="button" aria-expanded="true" aria-controls="secao-dias-atividades">
                    <span class="chevron">&#9660;</span>
                    {% trans "Etapa 3 de 4 - Designação dos Dias das Atividades" %} <small class="text-light">(clique para expandir/recolher)</small>
                </a>
            </h5>
            <p class="mb-0 mt-2"><small>{% trans "Selecione os dias específicos para cada atividade no mês escolhido." %}</small></p>
        </div>
        <div id="secao-dias-atividades" class="collapse show card-body">
            <form id="form-presenca" method="post" autocomplete="off">
                {% csrf_token %}
                <div id="mensagem-ajax" class="alert d-none" role="alert"></div>
                <div id="mensagem-erro-ajax" class="alert alert-danger d-none"></div>
                <div id="mensagem-validacao" class="alert alert-danger d-none" role="alert"></div>
                
                {% if atividades %}
                <div class="accordion" id="accordionAtividades">
            {% for atividade in atividades %}
            <div class="accordion-item mb-2">
                <h2 class="accordion-header" id="heading-{{ atividade.id }}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ atividade.id }}" aria-expanded="false" aria-controls="collapse-{{ atividade.id }}">
                            <i class="fas fa-calendar-day me-2"></i>
                            {{ atividade.nome }} <span class="ms-2 badge bg-secondary">{{ atividade.qtd_ativ_mes|default:'0' }} dias</span>
                        </button>
                </h2>
                <div id="collapse-{{ atividade.id }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ atividade.id }}" data-bs-parent="#accordionAtividades">
                    <div class="accordion-body p-0">
                        <div class="atividade-bloco-table table-responsive p-3">
                            <table class="table table-bordered table-sm mb-0" style="background:#f8f9fa;">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width:40%">Dias da atividade</th>
                                        <th>Observações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="vertical-align:middle;">
                                            <label for="dias-atividade-{{ atividade.id }}" class="form-label visually-hidden">Selecione os dias da atividade</label>
                                            <input type="text" id="dias-atividade-{{ atividade.id }}" name="presenca_{{ atividade.id }}" class="form-control dias-datepicker" placeholder="Clique para escolher os dias" readonly data-atividade="{{ atividade.id }}" data-maxdias="{{ atividade.qtd_ativ_mes|default:'0' }}">
                                            <div class="form-text">Selecione até {{ atividade.qtd_ativ_mes|default:'0' }} dia(s) no mês.</div>
                                            <div class="msg-limite-dias" id="msg-limite-{{ atividade.id }}"></div>
                                        </td>
                                        <td>
                                            <div id="obs-dias-{{ atividade.id }}" class="row g-2">
                                                <!-- Campos de observação por dia selecionado serão inseridos via JS -->
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
                </div>
        {% else %}
            <div class="alert alert-warning mt-3" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                {% trans "Nenhuma atividade encontrada para o mês/turma selecionados." %}<br>
                {% trans "Possíveis motivos:" %}
                <ul class="mt-2">
                    <li>{% trans "Não há atividades cadastradas para a turma selecionada." %}</li>
                    <li>{% trans "Os totais de atividades não foram preenchidos ou estão zerados." %}</li>
                    <li>{% trans "Houve um problema na seleção de turma ou atividades." %}</li>
                </ul>
            </div>
        {% endif %}
                
                <div class="mt-4">
                    <button type="submit" class="btn btn-success me-2" aria-label="{% trans 'Salvar e avançar para seleção de alunos' %}">
                        <i class="fas fa-arrow-right me-2"></i>{% trans "Salvar e Avançar" %}
                    </button>
                    <a href="{% url 'presencas:registrar_presenca_totais_atividades' %}" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-arrow-left me-2"></i>{% trans "Etapa Anterior" %}
                    </a>
                    <a href="{% url 'presencas:registrar_presenca_dados_basicos' %}" class="btn btn-outline-info">
                        <i class="fas fa-home me-2"></i>{% trans "Recomeçar" %}
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Flatpickr setup
    document.querySelectorAll('.dias-datepicker').forEach(function(input) {
        const atividadeId = input.dataset.atividade;
        const maxDias = parseInt(input.dataset.maxdias) || 0;
        const msgLimite = document.getElementById('msg-limite-' + atividadeId);
        flatpickr(input, {
            mode: 'multiple',
            dateFormat: 'd',
            minDate: new Date({{ ano }}, {{ mes }} - 1, 1),
            maxDate: new Date({{ ano }}, {{ mes }} - 1, {{ dias_do_mes|length }}),
            locale: 'pt',
            onChange: function(selectedDates, dateStr, instance) {
                if (selectedDates.length > maxDias) {
                    msgLimite.textContent = `Você só pode selecionar até ${maxDias} dia(s) para esta atividade. Caso deseje mais, volte e altere o total de dias na etapa anterior.`;
                    msgLimite.style.display = 'block';
                    // Remove o último selecionado
                    selectedDates.pop();
                    instance.setDate(selectedDates, true);
                    return;
                } else {
                    msgLimite.style.display = 'none';
                }
                // Limpa e insere campos de observação para cada dia selecionado
                const obsDiv = document.getElementById('obs-dias-' + atividadeId);
                obsDiv.innerHTML = '';
                selectedDates.forEach(function(date) {
                    const dia = date.getDate();
                    const obsInput = document.createElement('input');
                    obsInput.type = 'text';
                    obsInput.name = `obs_${atividadeId}_${dia}`;
                    obsInput.className = 'form-control obs-dia col-md-4';
                    obsInput.placeholder = `Obs. do dia ${dia}`;
                    obsInput.maxLength = 200;
                    obsDiv.appendChild(obsInput);
                });
            },
            onReady: function(selectedDates, dateStr, instance) {
                if (!instance.calendarContainer.querySelector('.flatpickr-ok')) {
                    const okBtn = document.createElement('button');
                    okBtn.type = 'button';
                    okBtn.textContent = 'OK';
                    okBtn.className = 'flatpickr-ok';
                    okBtn.onclick = function() {
                        instance.close();
                    };
                    instance.calendarContainer.appendChild(okBtn);
                }
            }
        });
    });

    // Validação do formulário antes do envio
    document.getElementById('form-presenca').addEventListener('submit', function(e) {
        let valid = true;
        let msg = '';
        let atividades = document.querySelectorAll('.dias-datepicker');
        if (atividades.length === 0) {
            msg = 'Nenhuma atividade foi selecionada para este mês/turma. Volte e preencha os totais de atividades.';
            valid = false;
        } else {
            atividades.forEach(function(input) {
                const maxDias = parseInt(input.dataset.maxdias) || 0;
                const selected = input._flatpickr ? input._flatpickr.selectedDates.length : 0;
                if (selected !== maxDias) {
                    valid = false;
                    msg += `Selecione exatamente ${maxDias} dia(s) para a atividade "${input.closest('.accordion-item').querySelector('.accordion-button').textContent.trim()}".\n`;
                }
            });
        }
        if (!valid) {
            e.preventDefault();
            let msgDiv = document.getElementById('mensagem-validacao');
            msgDiv.textContent = msg;
            msgDiv.classList.remove('d-none');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            return false;
        } else {
            document.getElementById('mensagem-validacao').classList.add('d-none');
        }
    });
});
</script>
{% endblock %}