{% extends "base.html" %}
{% load static %}
{% load presenca_extras %}

{% block content %}
<h2 style="font-size:1.3em;">Designação dos Dias das Atividades</h2>

{# Quadro resumo agora usa apenas as atividades filtradas #}
<div class="resumo-totais-atividades mb-3" style="background:#eaf6ff;border:1.5px solid #90caf9;padding:14px 22px 10px 22px;border-radius:10px;font-size:1em;max-width:700px;display:flex;align-items:center;gap:18px;box-shadow:0 2px 8px #e3eaf3;">
    <img src="{% static 'img/logo.png' %}" alt="Resumo" style="width:38px;height:38px;margin-right:10px;opacity:0.85;">
    <div>
        <strong style="font-size:1.08em;">Resumo dos Totais de Atividades deste mês:</strong>
        <ul style="margin-bottom:0;margin-top:4px;padding-left:18px;">
            {% if atividades and atividades|length > 0 %}
                {% for atividade in atividades %}
                    <li style="margin-bottom:2px;">
                        <span style="font-weight:500;">{{ atividade.nome|default:'(Sem nome)' }}</span>:
                        <span style="color:#1976d2;font-weight:600;">{{ atividade.qtd_ativ_mes|default:'0' }}</span> dia(s)
                    </li>
                {% endfor %}
            {% else %}
                <li>Nenhuma atividade cadastrada para o mês/turma.</li>
            {% endif %}
        </ul>
    </div>
</div>

{# DEBUG: Mostra IDs e nomes das atividades filtradas #}
<div class="alert alert-info" style="max-width:700px;">
    <strong>DEBUG:</strong> Atividades filtradas para os quadros:<br>
    {% if atividades %}
        <ul style="margin-bottom:0;">
        {% for atividade in atividades %}
            <li>ID: {{ atividade.id }} | Nome: {{ atividade.nome }} | qtd_ativ_mes: {{ atividade.qtd_ativ_mes }}</li>
        {% endfor %}
        </ul>
    {% else %}
        Nenhuma atividade filtrada.
    {% endif %}
</div>

<style>
    .atividades-container {
        display: flex;
        overflow-x: auto;
        gap: 12px;
        padding-bottom: 8px;
    }
    .atividade-quadro {
        min-width: 220px;
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 10px 8px;
        background: #fafafa;
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        font-size: 0.93em;
    }
    .atividade-quadro strong {
        font-size: 1em;
    }
    .minicalendario {
        display: flex;
        flex-direction: column;
        gap: 2px;
        margin-bottom: 6px;
        justify-content: flex-start;
        width: 100%;
    }
    .minicalendario .dia-linha {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 1px;
    }
    .minicalendario label {
        width: 28px;
        text-align: center;
        cursor: pointer;
        margin-bottom: 0;
        font-size: 0.92em;
    }
    .minicalendario input[type="text"] {
        flex: 1;
        min-width: 0;
        max-width: 110px;
        font-size: 0.92em;
        padding: 2px 4px;
        height: 26px;
    }
    .matriz-confirmada {
        margin-top: 8px;
        border-top: 1px solid #ddd;
        padding-top: 4px;
        font-size: 0.92em;
    }
    .obs-curta {
        display: inline;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 140px;
        vertical-align: bottom;
    }
    .btn-confirmar {
        font-size: 0.95em;
        padding: 2px 10px;
    }
    .btn-primary, .btn-success {
        font-size: 0.97em;
        padding: 4px 14px;
    }
</style>

<form id="form-presenca" method="post">
    {% csrf_token %}
    <div id="mensagem-ajax" class="alert d-none" role="alert"></div>
    <div id="mensagem-erro-ajax" class="alert alert-danger d-none"></div>
    <div class="atividades-container">
        {% if atividades %}
            {% for atividade in atividades %}
                <div class="atividade-quadro" id="quadro-{{ atividade.id }}">
                    <strong>
                        {{ atividade.nome }} ({{ atividade.qtd_ativ_mes|default:'0' }})
                    </strong>
                    <div>
                        <small>Mês: {{ mes }}/{{ ano }}</small>
                    </div>
                    <div class="minicalendario">
                        {% for dia in dias_do_mes %}
                        <div class="dia-linha">
                            <label>
                                <input type="checkbox"
                                    class="dia-checkbox"
                                    name="presenca_{{ atividade.id }}"
                                    value="{{ dia }}"
                                    data-atividade="{{ atividade.id }}"
                                    data-dia="{{ dia }}"
                                    {% if presencas and presencas|get_item:atividade.id and dia in presencas|get_item:atividade.id %}checked{% endif %}>
                                {{ dia }}
                            </label>
                            <input type="text"
                                name="obs_{{ atividade.id }}_{{ dia }}"
                                maxlength="200"
                                class="form-control obs-dia"
                                placeholder="Obs. deste dia"
                                value="{% if presencas_obs and presencas_obs|get_item:atividade.id and presencas_obs|get_item:atividade.id|get_item:dia %}{{ presencas_obs|get_item:atividade.id|get_item:dia }}{% endif %}">
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button"
                        class="btn btn-success btn-confirmar"
                        data-atividade="{{ atividade.id }}"
                        data-qtd="{{ atividade.qtd_ativ_mes|default:'0' }}">
                        Confirmar
                    </button>
                    <div class="matriz-confirmada" id="matriz-{{ atividade.id }}" style="display:none;">
                        <!-- Lista dos dias e observações confirmadas aparecerá aqui -->
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="alert alert-warning">
                Nenhuma atividade encontrada para o mês/turma selecionados.<br>
                Volte e preencha os totais de atividades.
            </div>
        {% endif %}
    </div>
    <button type="submit" class="btn btn-primary">Salvar e avançar</button>
</form>

<script src="{% static 'js/presencas/registrar_presenca_dias_atividades.js' %}"></script>
<script src="{% static 'js/presencas/limpar_form_dias_atividades.js' %}"></script>
{% endblock %}