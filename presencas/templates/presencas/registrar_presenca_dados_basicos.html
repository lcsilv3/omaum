<!-- filepath: presencas/templates/presencas/registrar_presenca_dados_basicos.html -->
{% extends 'base.html' %}
{% load i18n %}
{% load static %}
{% load widget_tweaks %}

{% block extra_css %}
{{ form.media.css }}
<style>
  .select2-container .select2-selection--single {
    height: calc(1.5em + .75rem + 2px);
  }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header">
            <h4 class="card-title mb-0">{% trans "Registrar Presença - Etapa 1 de 4" %}</h4>
            <p class="card-subtitle text-muted">{% trans "Selecione o curso, a turma e o período." %}</p>
        </div>
        <div class="card-body">
            <form id="form-dados-basicos" method="post" autocomplete="off" action="{% url 'presencas:registrar_presenca_dados_basicos_ajax' %}" novalidate>
                {% csrf_token %}
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="{{ form.curso.id_for_label }}" class="form-label">{{ form.curso.label }}</label>
                        {% render_field form.curso class="form-control" %}
                        {% if form.curso.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.curso.errors|first }}
                            </div>
                        {% endif %}
                    </div>

                    <div class="col-md-6">
                        <label for="{{ form.turma.id_for_label }}" class="form-label">{{ form.turma.label }}</label>
                        {% render_field form.turma class="form-control" %}
                        <span id="loading-turmas" class="ms-2 text-primary d-none" aria-live="polite">{% trans "Carregando turmas..." %}</span>
                        {% if form.turma.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.turma.errors|first }}
                            </div>
                        {% endif %}
                    </div>

                    <div class="col-md-6">
                        <label for="{{ form.ano.id_for_label }}" class="form-label">{{ form.ano.label }}</label>
                        {% render_field form.ano class="form-select" %}
                        {% if form.ano.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.ano.errors|first }}
                            </div>
                        {% endif %}
                    </div>

                    <div class="col-md-6">
                        <label for="{{ form.mes.id_for_label }}" class="form-label">{{ form.mes.label }}</label>
                        {% render_field form.mes class="form-select" %}
                        {% if form.mes.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.mes.errors|first }}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="mt-4">
                    <button type="submit" class="btn btn-primary" aria-label="Confirmar e avançar para totais de atividades">
                        <i class="fas fa-arrow-right me-2"></i>{% trans "Avançar" %}
                    </button>
                </div>
            </form>
            <div id="form-errors" class="alert alert-danger mt-3 d-none" role="alert"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ form.media.js }}
<script>
$(function () {
    // Inicializa Select2
    $('#id_curso').select2({
        theme: 'bootstrap-5',
        placeholder: '{% trans "Selecione um curso" %}',
        allowClear: true
    });
    $('#id_turma').select2({
        theme: 'bootstrap-5',
        placeholder: '{% trans "Selecione uma turma" %}',
        allowClear: true
    });

    // Carrega turmas via AJAX
    $('#id_curso').on('change', function () {
        const cursoId = $(this).val();
        const turmaSelect = $('#id_turma');
        const loadingSpan = $('#loading-turmas');

        turmaSelect.empty().append('<option value=""></option>').trigger('change');

        if (cursoId) {
            loadingSpan.removeClass('d-none');
            $.ajax({
                url: '{% url "turmas:turmas_por_curso_json" %}',
                data: { 'curso_id': cursoId },
                success: function (data) {
                    turmaSelect.select2({
                        theme: 'bootstrap-5',
                        placeholder: '{% trans "Selecione uma turma" %}',
                        allowClear: true,
                        data: $.map(data, function(item) {
                            return { id: item.id, text: item.nome };
                        })
                    });
                    turmaSelect.val(null).trigger('change');
                },
                complete: function() {
                    loadingSpan.addClass('d-none');
                }
            });
        }
    });

    // Submissão do formulário via AJAX
    $('#form-dados-basicos').on('submit', function(e) {
        e.preventDefault();
        const form = $(this);
        const errorDiv = $('#form-errors');

        $.ajax({
            type: 'POST',
            url: form.attr('action'),
            data: form.serialize(),
            success: function(response) {
                if (response.success) {
                    window.location.href = response.redirect_url;
                } else {
                    let errorHtml = '<ul>';
                    $.each(response.errors, function(field, errors) {
                        errorHtml += '<li>' + field + ': ' + errors.join(', ') + '</li>';
                    });
                    errorHtml += '</ul>';
                    errorDiv.html(errorHtml).removeClass('d-none');
                }
            },
            error: function() {
                errorDiv.text('{% trans "Ocorreu um erro de comunicação. Tente novamente." %}').removeClass('d-none');
            }
        });
    });
});
</script>
{% endblock %}