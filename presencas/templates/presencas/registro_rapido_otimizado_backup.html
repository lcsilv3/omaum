{% extends "base.html" %}
{% load static %}

{% block title %}Registro Rápido de Presenças{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    .presenca-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .form-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 25px;
        margin-bottom: 20px;
    }
    
    .quick-filters {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    
    .quick-filters .form-group {
        flex: 1;
        min-width: 200px;
    }
    
    .alunos-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }
    
    .aluno-card {
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        background: white;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
    }
    
    .aluno-card:hover {
        border-color: #007bff;
        box-shadow: 0 4px 12px rgba(0,123,255,0.15);
    }
    
    .aluno-card.presente {
        border-color: #28a745;
        background-color: #f8fff9;
    }
    
    .aluno-card.ausente {
        border-color: #dc3545;
        background-color: #fff8f8;
    }
    
    .aluno-card.ja-registrado {
        opacity: 0.8;
        background-color: #f8f9fa;
    }
    
    .aluno-info h5 {
        margin: 0 0 8px 0;
        color: #333;
        font-size: 16px;
    }
    
    .aluno-info .cpf {
        color: #666;
        font-size: 14px;
        margin-bottom: 5px;
    }
    
    .aluno-info .curso {
        color: #888;
        font-size: 12px;
    }
    
    .presenca-controls {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        justify-content: center;
    }
    
    .btn-presenca {
        flex: 1;
        padding: 8px 16px;
        border: none;
        border-radius: 5px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .btn-presente {
        background-color: #28a745;
        color: white;
    }
    
    .btn-presente:hover {
        background-color: #218838;
    }
    
    .btn-ausente {
        background-color: #dc3545;
        color: white;
    }
    
    .btn-ausente:hover {
        background-color: #c82333;
    }
    
    .btn-presente.active {
        background-color: #1e7e34;
        box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.3);
    }
    
    .btn-ausente.active {
        background-color: #bd2130;
        box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.3);
    }
    
    .status-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
        text-transform: uppercase;
    }
    
    .status-badge.presente {
        background-color: #28a745;
        color: white;
    }
    
    .status-badge.ausente {
        background-color: #dc3545;
        color: white;
    }
    
    .status-badge.ja-registrado {
        background-color: #6c757d;
        color: white;
    }
    
    .search-container {
        position: relative;
        margin-bottom: 20px;
    }
    
    .search-input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 16px;
    }
    
    .search-input:focus {
        border-color: #007bff;
        outline: none;
        box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
    }
    
    .action-buttons {
        display: flex;
        gap: 15px;
        margin-top: 25px;
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .btn-primary, .btn-success, .btn-warning {
        padding: 12px 25px;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 150px;
    }
    
    .btn-primary {
        background-color: #007bff;
        color: white;
    }
    
    .btn-primary:hover {
        background-color: #0056b3;
    }
    
    .btn-success {
        background-color: #28a745;
        color: white;
    }
    
    .btn-success:hover {
        background-color: #218838;
    }
    
    .btn-warning {
        background-color: #ffc107;
        color: #212529;
    }
    
    .btn-warning:hover {
        background-color: #e0a800;
    }
    
    .loading {
        display: none;
        text-align: center;
        padding: 20px;
    }
    
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .stats-bar {
        display: flex;
        justify-content: space-around;
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .stat-item {
        text-align: center;
    }
    
    .stat-number {
        font-size: 24px;
        font-weight: bold;
        color: #007bff;
        display: block;
    }
    
    .stat-label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
    }
    
    .observacao-input {
        width: 100%;
        margin-top: 10px;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        resize: none;
        font-size: 13px;
        display: none;
    }
    
    .aluno-card.com-observacao .observacao-input {
        display: block;
    }
    
    .btn-observacao {
        background: none;
        border: none;
        color: #007bff;
        cursor: pointer;
        font-size: 12px;
        padding: 2px 5px;
        text-decoration: underline;
    }
    
    .keyboard-shortcuts {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-size: 12px;
        display: none;
    }
    
    .keyboard-shortcuts.show {
        display: block;
    }
    
    @media (max-width: 768px) {
        .presenca-container {
            padding: 10px;
        }
        
        .quick-filters {
            flex-direction: column;
        }
        
        .alunos-grid {
            grid-template-columns: 1fr;
            gap: 10px;
        }
        
        .action-buttons {
            flex-direction: column;
        }
        
        .btn-primary, .btn-success, .btn-warning {
            width: 100%;
            margin-bottom: 10px;
        }
        
        .presenca-controls {
            flex-direction: column;
        }
        
        .btn-presenca {
            padding: 12px;
            font-size: 16px;
        }
    }
    
    .select2-container .select2-selection--single {
        height: 38px;
        border-color: #e9ecef;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 36px;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 36px;
    }
</style>
{% endblock %}

{% block content %}
<div class="presenca-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-check-circle"></i> Registro Rápido de Presenças</h1>
        <button type="button" class="btn btn-outline-info btn-sm" onclick="toggleKeyboardShortcuts()">
            <i class="fas fa-keyboard"></i> Atalhos
        </button>
    </div>
    
    <!-- Formulário Principal -->
    <div class="form-card">
        <h3><i class="fas fa-cog"></i> Configurações</h3>
        <form id="configForm">
            <div class="quick-filters">
                <div class="form-group">
                    <label for="turma"><strong>Turma *</strong></label>
                    <select id="turma" name="turma" class="form-control" required>
                        <option value="">Selecione uma turma</option>
                        {% for turma in turmas %}
                        <option value="{{ turma.id }}">{{ turma.nome }} - {{ turma.curso.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="atividade"><strong>Atividade *</strong></label>
                    <select id="atividade" name="atividade" class="form-control" required>
                        <option value="">Selecione uma atividade</option>
                        {% for atividade in atividades %}
                        <option value="{{ atividade.id }}">{{ atividade.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="data"><strong>Data *</strong></label>
                    <input type="date" id="data" name="data" class="form-control" 
                           value="{{ data_hoje|date:'Y-m-d' }}" required>
                </div>
            </div>
            
            <div class="action-buttons">
                <button type="button" class="btn btn-primary" onclick="carregarAlunosTurma()">
                    <i class="fas fa-users"></i> Carregar Alunos da Turma
                </button>
            </div>
        </form>
    </div>
    
    <!-- Busca Rápida -->
    <div class="form-card" id="buscaSection" style="display: none;">
        <h3><i class="fas fa-search"></i> Busca Rápida de Aluno</h3>
        <div class="search-container">
            <input type="text" id="buscaAluno" class="search-input" 
                   placeholder="Digite nome ou CPF do aluno (mín. 2 caracteres)...">
        </div>
        <div id="resultadosBusca"></div>
    </div>
    
    <!-- Estatísticas -->
    <div class="stats-bar" id="statsBar" style="display: none;">
        <div class="stat-item">
            <span class="stat-number" id="totalAlunos">0</span>
            <span class="stat-label">Total</span>
        </div>
        <div class="stat-item">
            <span class="stat-number" id="totalPresentes">0</span>
            <span class="stat-label">Presentes</span>
        </div>
        <div class="stat-item">
            <span class="stat-number" id="totalAusentes">0</span>
            <span class="stat-label">Ausentes</span>
        </div>
        <div class="stat-item">
            <span class="stat-number" id="totalPendentes">0</span>
            <span class="stat-label">Pendentes</span>
        </div>
    </div>
    
    <!-- Loading -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Carregando alunos...</p>
    </div>
    
    <!-- Lista de Alunos -->
    <div id="alunosContainer" style="display: none;">
        <div class="form-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3><i class="fas fa-users"></i> Alunos da Turma</h3>
                <div>
                    <button type="button" class="btn btn-success btn-sm" onclick="marcarTodosPresente()">
                        <i class="fas fa-check-circle"></i> Todos Presentes
                    </button>
                    <button type="button" class="btn btn-danger btn-sm" onclick="marcarTodosAusente()">
                        <i class="fas fa-times-circle"></i> Todos Ausentes
                    </button>
                </div>
            </div>
            
            <div class="alunos-grid" id="alunosGrid">
                <!-- Alunos serão carregados aqui via AJAX -->
            </div>
            
            <div class="action-buttons">
                <button type="button" class="btn btn-success" onclick="salvarPresencas()">
                    <i class="fas fa-save"></i> Salvar Presenças
                </button>
                <button type="button" class="btn btn-warning" onclick="limparSelecoes()">
                    <i class="fas fa-eraser"></i> Limpar Seleções
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Atalhos do Teclado -->
<div class="keyboard-shortcuts" id="keyboardShortcuts">
    <strong>Atalhos do Teclado:</strong><br>
    <kbd>Ctrl</kbd> + <kbd>A</kbd> - Todos Presentes<br>
    <kbd>Ctrl</kbd> + <kbd>D</kbd> - Todos Ausentes<br>
    <kbd>Ctrl</kbd> + <kbd>S</kbd> - Salvar<br>
    <kbd>Ctrl</kbd> + <kbd>L</kbd> - Limpar<br>
    <kbd>Esc</kbd> - Fechar Atalhos
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="{% static 'presencas/js/registro_rapido.js' %}"></script>
<script>
// Script de inicialização básico - funcionalidade principal está em registro_rapido.js

$(document).ready(function() {
    // Inicializar Select2
    $('#turma, #atividade').select2({
        theme: 'default',
        width: '100%'
    });
    
    // Eventos de teclado
    $(document).keydown(function(e) {
        if (e.ctrlKey) {
            switch(e.which) {
                case 65: // Ctrl+A
                    e.preventDefault();
                    marcarTodosPresente();
                    break;
                case 68: // Ctrl+D
                    e.preventDefault();
                    marcarTodosAusente();
                    break;
                case 83: // Ctrl+S
                    e.preventDefault();
                    salvarPresencas();
                    break;
                case 76: // Ctrl+L
                    e.preventDefault();
                    limparSelecoes();
                    break;
            }
        } else if (e.which === 27) { // Esc
            $('#keyboardShortcuts').removeClass('show');
        }
    });
    
    // Busca em tempo real
    let buscaTimeout;
    $('#buscaAluno').on('input', function() {
        clearTimeout(buscaTimeout);
        const query = $(this).val().trim();
        
        if (query.length >= 2) {
            buscaTimeout = setTimeout(() => {
                buscarAlunos(query);
            }, 300);
        } else {
            $('#resultadosBusca').empty();
        }
    });
});

function carregarAlunosTurma() {
    const turmaId = $('#turma').val();
    const atividadeId = $('#atividade').val();
    const data = $('#data').val();
    
    if (!turmaId || !atividadeId || !data) {
        showToast('Por favor, selecione turma, atividade e data', 'warning');
        return;
    }
    
    $('#loading').show();
    $('#alunosContainer').hide();
    
    $.ajax({
        url: '{% url "presencas:obter_alunos_turma_ajax" %}',
        data: {
            'turma_id': turmaId
        },
        success: function(response) {
            if (response.alunos) {
                alunosData = response.alunos;
                renderizarAlunos();
                $('#buscaSection').show();
                $('#alunosContainer').show();
                $('#statsBar').show();
                atualizarEstatisticas();
            }
        },
        error: function(xhr) {
            showToast('Erro ao carregar alunos da turma', 'error');
        },
        complete: function() {
            $('#loading').hide();
        }
    });
}

function renderizarAlunos() {
    const grid = $('#alunosGrid');
    grid.empty();
    
    alunosData.forEach(function(aluno) {
        const presencaAtual = presencasModificadas[aluno.id] !== undefined 
            ? presencasModificadas[aluno.id] 
            : aluno.presente;
            
        const jaRegistrado = aluno.ja_registrado;
        
        let statusClass = '';
        let statusBadge = '';
        
        if (presencaAtual === true) {
            statusClass = 'presente';
            statusBadge = '<span class="status-badge presente">Presente</span>';
        } else if (presencaAtual === false) {
            statusClass = 'ausente';
            statusBadge = '<span class="status-badge ausente">Ausente</span>';
        } else if (jaRegistrado) {
            statusClass = 'ja-registrado';
            statusBadge = '<span class="status-badge ja-registrado">Registrado</span>';
        }
        
        const alunoHtml = `
            <div class="aluno-card ${statusClass}" data-aluno-id="${aluno.id}">
                ${statusBadge}
                <div class="aluno-info">
                    <h5>${aluno.nome}</h5>
                    <div class="cpf">CPF: ${aluno.cpf}</div>
                    <div class="curso">${aluno.curso}</div>
                </div>
                <div class="presenca-controls">
                    <button type="button" class="btn-presenca btn-presente ${presencaAtual === true ? 'active' : ''}" 
                            onclick="marcarPresenca(${aluno.id}, true)">
                        <i class="fas fa-check"></i> Presente
                    </button>
                    <button type="button" class="btn-presenca btn-ausente ${presencaAtual === false ? 'active' : ''}" 
                            onclick="marcarPresenca(${aluno.id}, false)">
                        <i class="fas fa-times"></i> Ausente
                    </button>
                </div>
                <button type="button" class="btn-observacao" onclick="toggleObservacao(${aluno.id})">
                    + Observação
                </button>
                <textarea class="observacao-input" id="obs-${aluno.id}" 
                          placeholder="Digite uma observação..."></textarea>
            </div>
        `;
        
        grid.append(alunoHtml);
    });
}

function marcarPresenca(alunoId, presente) {
    presencasModificadas[alunoId] = presente;
    
    const card = $(`.aluno-card[data-aluno-id="${alunoId}"]`);
    const btnPresente = card.find('.btn-presente');
    const btnAusente = card.find('.btn-ausente');
    
    // Remover classes ativas
    btnPresente.removeClass('active');
    btnAusente.removeClass('active');
    card.removeClass('presente ausente');
    
    // Adicionar classe apropriada
    if (presente) {
        btnPresente.addClass('active');
        card.addClass('presente');
        card.find('.status-badge').remove();
        card.prepend('<span class="status-badge presente">Presente</span>');
    } else {
        btnAusente.addClass('active');
        card.addClass('ausente');
        card.find('.status-badge').remove();
        card.prepend('<span class="status-badge ausente">Ausente</span>');
    }
    
    atualizarEstatisticas();
}

function marcarTodosPresente() {
    alunosData.forEach(function(aluno) {
        marcarPresenca(aluno.id, true);
    });
}

function marcarTodosAusente() {
    alunosData.forEach(function(aluno) {
        marcarPresenca(aluno.id, false);
    });
}

function limparSelecoes() {
    if (confirm('Deseja limpar todas as seleções?')) {
        presencasModificadas = {};
        $('.observacao-input').val('');
        $('.aluno-card').removeClass('com-observacao');
        renderizarAlunos();
        atualizarEstatisticas();
    }
}

function toggleObservacao(alunoId) {
    const card = $(`.aluno-card[data-aluno-id="${alunoId}"]`);
    card.toggleClass('com-observacao');
    
    if (card.hasClass('com-observacao')) {
        $(`#obs-${alunoId}`).focus();
    }
}

function atualizarEstatisticas() {
    let totalPresentes = 0;
    let totalAusentes = 0;
    let totalPendentes = 0;
    
    alunosData.forEach(function(aluno) {
        const presencaAtual = presencasModificadas[aluno.id] !== undefined 
            ? presencasModificadas[aluno.id] 
            : aluno.presente;
            
        if (presencaAtual === true) {
            totalPresentes++;
        } else if (presencaAtual === false) {
            totalAusentes++;
        } else {
            totalPendentes++;
        }
    });
    
    $('#totalAlunos').text(alunosData.length);
    $('#totalPresentes').text(totalPresentes);
    $('#totalAusentes').text(totalAusentes);
    $('#totalPendentes').text(totalPendentes);
}

function salvarPresencas() {
    const turmaId = $('#turma').val();
    const atividadeId = $('#atividade').val();
    const data = $('#data').val();
    
    if (!turmaId || !atividadeId || !data) {
        showToast('Por favor, configure turma, atividade e data', 'warning');
        return;
    }
    
    // Preparar dados das presenças
    const presencas = [];
    
    Object.keys(presencasModificadas).forEach(function(alunoId) {
        const observacao = $(`#obs-${alunoId}`).val() || '';
        
        presencas.push({
            aluno_id: parseInt(alunoId),
            presente: presencasModificadas[alunoId],
            observacao: observacao
        });
    });
    
    if (presencas.length === 0) {
        showToast('Nenhuma presença foi marcada', 'warning');
        return;
    }
    
    // Mostrar loading
    $('#loading').show();
    
    // Salvar via AJAX
    $.ajax({
        url: '{% url "presencas:salvar_presencas_lote_ajax" %}',
        method: 'POST',
        data: JSON.stringify({
            turma_id: parseInt(turmaId),
            atividade_id: parseInt(atividadeId),
            data: data,
            presencas: presencas
        }),
        contentType: 'application/json',
        success: function(response) {
            if (response.success) {
                showToast(`Presenças salvas! ${response.registradas} registradas, ${response.atualizadas} atualizadas`, 'success');
                
                if (response.erros.length > 0) {
                    console.warn('Erros durante o salvamento:', response.erros);
                }
                
                // Recarregar alunos para mostrar status atualizado
                setTimeout(() => {
                    carregarAlunosTurma();
                }, 1000);
            } else {
                showToast('Erro ao salvar presenças', 'error');
            }
        },
        error: function(xhr) {
            const errorMsg = xhr.responseJSON?.error || 'Erro interno do servidor';
            showToast(`Erro: ${errorMsg}`, 'error');
        },
        complete: function() {
            $('#loading').hide();
        }
    });
}

function buscarAlunos(query) {
    const turmaId = $('#turma').val();
    
    $.ajax({
        url: '{% url "presencas:buscar_alunos_ajax" %}',
        data: {
            'q': query,
            'turma_id': turmaId,
            'limit': 10
        },
        success: function(response) {
            const container = $('#resultadosBusca');
            container.empty();
            
            if (response.alunos && response.alunos.length > 0) {
                const html = response.alunos.map(aluno => `
                    <div class="aluno-card" onclick="adicionarAlunoRapido(${aluno.id}, '${aluno.nome}', '${aluno.cpf}')">
                        <div class="aluno-info">
                            <h5>${aluno.nome}</h5>
                            <div class="cpf">CPF: ${aluno.cpf}</div>
                            <div class="curso">${aluno.curso}</div>
                        </div>
                    </div>
                `).join('');
                container.html(html);
            } else {
                container.html('<p class="text-muted">Nenhum aluno encontrado</p>');
            }
        },
        error: function() {
            $('#resultadosBusca').html('<p class="text-danger">Erro na busca</p>');
        }
    });
}

function adicionarAlunoRapido(alunoId, nome, cpf) {
    // Verificar se aluno já está na lista
    const alunoExiste = alunosData.find(a => a.id === alunoId);
    
    if (!alunoExiste) {
        // Adicionar aluno à lista principal
        alunosData.push({
            id: alunoId,
            nome: nome,
            cpf: cpf,
            curso: 'Busca Individual',
            presente: null,
            ja_registrado: false
        });
        
        renderizarAlunos();
        atualizarEstatisticas();
    }
    
    // Focar no aluno adicionado
    $(`.aluno-card[data-aluno-id="${alunoId}"]`)[0].scrollIntoView({
        behavior: 'smooth',
        block: 'center'
    });
    
    // Limpar busca
    $('#buscaAluno').val('');
    $('#resultadosBusca').empty();
}

function toggleKeyboardShortcuts() {
    $('#keyboardShortcuts').toggleClass('show');
}

function showToast(message, type = 'info') {
    // Implementação simples de toast
    const toastClass = type === 'success' ? 'alert-success' : 
                     type === 'error' ? 'alert-danger' : 
                     type === 'warning' ? 'alert-warning' : 'alert-info';
    
    const toast = $(`
        <div class="alert ${toastClass} alert-dismissible fade show" role="alert" 
             style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
            ${message}
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        </div>
    `);
    
    $('body').append(toast);
    
    setTimeout(() => {
        toast.alert('close');
    }, 5000);
}
</script>
{% endblock %}
