{% extends "base.html" %}
{% load static %}

{% block title %}{{ titulo }}{% endblock %}

{% block head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .correlacao-forte { background-color: #e8f5e8; border-left: 4px solid #4caf50; }
        .correlacao-media { background-color: #fff3e0; border-left: 4px solid #ff9800; }
        .correlacao-fraca { background-color: #ffebee; border-left: 4px solid #f44336; }
        .stats-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .nota-alta { color: #4caf50; font-weight: bold; }
        .nota-media { color: #ff9800; font-weight: bold; }
        .nota-baixa { color: #f44336; font-weight: bold; }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Cabeçalho -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card stats-card">
                <div class="card-body">
                    <h4><i class="fas fa-chart-line"></i> {{ titulo }}</h4>
                    <p class="mb-0">Análise estatística da correlação entre frequência de presença e desempenho acadêmico</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros Dinâmicos -->
    <div class="card mb-4">
        <div class="card-header">
            <h5><i class="fas fa-filter"></i> Filtros</h5>
        </div>
        <div class="card-body">
            <form id="filtroForm" class="row g-3">
                <div class="col-md-3">
                    <label for="ano" class="form-label">Ano:</label>
                    <select id="ano" name="ano" class="form-select">
                        <option value="">Todos os anos</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="turma_id" class="form-label">Turma:</label>
                    <select id="turma_id" name="turma_id" class="form-select">
                        <option value="">Todas as turmas</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="disciplina" class="form-label">Disciplina:</label>
                    <select id="disciplina" name="disciplina" class="form-select">
                        <option value="">Todas as disciplinas</option>
                        <option value="matematica">Matemática</option>
                        <option value="portugues">Português</option>
                        <option value="ciencias">Ciências</option>
                        <option value="historia">História</option>
                        <option value="geografia">Geografia</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button type="button" id="btnFiltrar" class="btn btn-primary" style="margin-top: 32px;">
                        <i class="fas fa-search"></i> Aplicar Filtros
                    </button>
                    <a href="{% url 'exportar_csv_correlacao_presenca_desempenho' %}" class="btn btn-success" id="btnExportar" style="margin-top: 32px;">
                        <i class="fas fa-download"></i> CSV
                    </a>
                </div>
            </form>
        </div>
    </div>

    {% if erro %}
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i> {{ erro }}
        </div>
    {% else %}
        <!-- Estatísticas de Correlação -->
        {% if estatisticas %}
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center correlacao-forte">
                    <div class="card-body">
                        <h3>{{ estatisticas.correlacao_coeficiente|floatformat:3|default:"N/A" }}</h3>
                        <p class="mb-0">Coeficiente de Correlação</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h3>{{ estatisticas.media_presenca|floatformat:1|default:"N/A" }}%</h3>
                        <p class="mb-0">Média de Presença</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h3>{{ estatisticas.media_nota|floatformat:1|default:"N/A" }}</h3>
                        <p class="mb-0">Média de Nota</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h3>{{ estatisticas.total_analisados|default:"0" }}</h3>
                        <p class="mb-0">Alunos Analisados</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Gráfico de Dispersão -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-chart-scatter"></i> Gráfico de Correlação Presença vs Desempenho</h5>
            </div>
            <div class="card-body">
                <canvas id="chartCorrelacao" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Tabela de Dados -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-table"></i> Dados Detalhados</h5>
            </div>
            <div class="card-body">
                <div id="conteudoTabela">
                    {% include "presencas/partials/tabela_correlacao.html" %}
                </div>
            </div>
        </div>
    {% endif %}
</div>

<script src="{% static 'presencas/js/filtros_dinamicos.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Configurar filtros
    configurarFiltros({
        endpointTurmas: '{% url "ajax_turmas" %}',
        endpointAnos: '{% url "ajax_anos" %}',
        endpointFiltro: '{% url "filtrar_correlacao_presenca_desempenho" %}',
        templateTabela: 'presencas/partials/tabela_correlacao.html'
    });

    // Gráfico de correlação
    {% if correlacoes %}
    const ctx = document.getElementById('chartCorrelacao').getContext('2d');
    
    const dadosGrafico = [
        {% for item in correlacoes %}
        {
            x: {{ item.percentual_presenca|default:0 }},
            y: {{ item.nota_estimada|default:0 }},
            label: '{{ item.aluno_nome|escapejs }}'
        },
        {% endfor %}
    ];

    new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Presença vs Desempenho',
                data: dadosGrafico,
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Percentual de Presença (%)'
                    },
                    min: 0,
                    max: 100
                },
                y: {
                    title: {
                        display: true,
                        text: 'Nota Estimada'
                    },
                    min: 0,
                    max: 10
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.raw.label + ': ' + 
                                   context.parsed.x + '% presença, ' + 
                                   context.parsed.y.toFixed(1) + ' nota';
                        }
                    }
                }
            }
        }
    });
    {% endif %}
});
</script>
{% endblock %}
