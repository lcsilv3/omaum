{% extends 'base.html' %}
{% load i18n %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'presencas/css/presencas.css' %}">
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>{% trans "Registrar Presença" %}</h1>
        <div class="btn-group" role="group">
            <a href="{% url 'presencas:registrar_presenca_dias_atividades' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> {% trans "Etapa Anterior" %}
            </a>
            <a href="{% url 'presencas:listar_presencas_academicas' %}" class="btn btn-secondary">
                <i class="fas fa-home"></i> {% trans "Voltar à Lista" %}
            </a>
        </div>
    </div>
    
    <!-- Resumo das Etapas Anteriores -->
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0">
                <a class="collapse-toggle text-white text-decoration-none" data-bs-toggle="collapse" href="#secao-resumo" role="button" aria-expanded="false" aria-controls="secao-resumo">
                    <span class="chevron">&#9654;</span>
                    {% trans "Resumo das Etapas Anteriores" %} <small class="text-light">(clique para expandir/recolher)</small>
                </a>
            </h5>
        </div>
        <div id="secao-resumo" class="collapse card-body">
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="resumo-item">
                        <h6><i class="fas fa-graduation-cap me-2"></i>{% trans "Dados Básicos" %}</h6>
                        <p class="mb-1"><strong>{% trans "Curso:" %}</strong> {{ turma.curso.nome }}</p>
                        <p class="mb-1"><strong>{% trans "Turma:" %}</strong> {{ turma.nome }}</p>
                        <p class="mb-0"><strong>{% trans "Período:" %}</strong> {{ nome_mes }}/{{ ano }}</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="resumo-item">
                        <h6><i class="fas fa-users me-2"></i>{% trans "Resumo de Alunos" %}</h6>
                        <p class="mb-0"><strong>{% trans "Total de alunos convocados:" %}</strong> {{ total_alunos }}</p>
                    </div>
                </div>
            </div>
            
            {% if resumo_atividades %}
            <div class="mt-3">
                <h6><i class="fas fa-tasks me-2"></i>{% trans "Atividades Configuradas" %}</h6>
                <div class="row">
                    {% for atividade in resumo_atividades %}
                    <div class="col-md-6 mb-2">
                        <div class="card card-body py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <strong>{{ atividade.nome }}</strong>
                                <span class="badge bg-primary">{{ atividade.total_dias }} {% trans "dias" %}</span>
                            </div>
                            {% if atividade.dias_selecionados %}
                                <small class="text-muted">
                                    {% trans "Dias:" %} 
                                    {% for dia in atividade.dias_selecionados %}{{ dia }}{% if not forloop.last %}, {% endif %}{% endfor %}
                                </small>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Etapa 4: Marcação de Presença -->
    <div class="card">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">
                <a class="collapse-toggle text-white text-decoration-none" data-bs-toggle="collapse" href="#secao-marcacao-presenca" role="button" aria-expanded="true" aria-controls="secao-marcacao-presenca">
                    <span class="chevron">&#9660;</span>
                    {% trans "Etapa 4 de 4 - Marcação de Presença dos Alunos" %} <small class="text-light">(clique para expandir/recolher)</small>
                </a>
            </h5>
            <p class="mb-0 mt-2"><small>{% trans "Marque os alunos como presentes ou ausentes para as atividades configuradas." %}</small></p>
        </div>
        <div id="secao-marcacao-presenca" class="collapse show card-body">
            <form id="form-alunos-presenca" method="post" autocomplete="off" aria-labelledby="titulo-pagina">
                {% csrf_token %}
                
                <!-- Seletor de Modo -->
                <div class="card mb-4 border-primary">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-cogs me-2"></i>{% trans "Modo de Marcação de Presença" %}
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="form-check form-check-lg">
                                    <input class="form-check-input" type="radio" name="modo_marcacao" id="modo_lote" value="lote" checked>
                                    <label class="form-check-label" for="modo_lote">
                                        <strong><i class="fas fa-users me-2"></i>{% trans "Modo Lote" %}</strong>
                                        <br><small class="text-muted">{% trans "Marcar todos os alunos com o mesmo status para todas as atividades" %}</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-check form-check-lg">
                                    <input class="form-check-input" type="radio" name="modo_marcacao" id="modo_individual" value="individual">
                                    <label class="form-check-label" for="modo_individual">
                                        <strong><i class="fas fa-user-check me-2"></i>{% trans "Modo Individual" %}</strong>
                                        <br><small class="text-muted">{% trans "Controle granular: marcar presença por aluno em cada atividade separadamente" %}</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Interface Modo Lote -->
                <div id="interface-modo-lote">
                    {% if alunos %}
                    <div class="mb-3">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            {% trans "Por padrão, todos os alunos estão marcados como" %} <strong>{% trans "PRESENTES" %}</strong>. 
                            {% trans "Use os botões abaixo para marcar como ausente apenas aqueles que faltaram." %}
                        </div>
                    </div>
                
                    <div class="row">
                        {% for aluno in alunos %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card aluno-card presente p-3 h-100" id="card-{{ aluno.cpf }}">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <span class="fw-bold" id="aluno-label-{{ aluno.cpf }}">{{ aluno.nome }}</span>
                                    <span class="badge bg-success" id="badge-presente-{{ aluno.cpf }}" aria-live="polite" style="font-size:1em;">{% trans "Presente" %}</span>
                                    <span class="badge bg-danger d-none" id="badge-ausente-{{ aluno.cpf }}" aria-live="polite" style="font-size:1em;">{% trans "Ausente" %}</span>
                                </div>
                                <div class="mt-2">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input toggle-presenca" type="checkbox" id="toggle-{{ aluno.cpf }}" name="aluno_{{ aluno.cpf }}_status" value="ausente"
                                            role="switch" aria-checked="false" aria-labelledby="aluno-label-{{ aluno.cpf }} label-ausente-{{ aluno.cpf }}">
                                        <label class="form-check-label" for="toggle-{{ aluno.cpf }}" id="label-ausente-{{ aluno.cpf }}">{% trans "Marcar como Ausente" %}</label>
                                    </div>
                                    <div class="mt-2 justificativa-group d-none" id="justificativa-group-{{ aluno.cpf }}">
                                        <label for="justificativa-{{ aluno.cpf }}" class="form-label">{% trans "Justificativa da falta" %}</label>
                                        <input type="text" class="form-control justificativa-input" name="aluno_{{ aluno.cpf }}_justificativa" id="justificativa-{{ aluno.cpf }}" placeholder="{% trans 'Informe o motivo da ausência' %}" aria-required="true" maxlength="255">
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="alert alert-warning mt-3" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        {% trans "Nenhum aluno disponível para marcação de presença nesta etapa." %}<br>
                        {% trans "Possíveis motivos:" %}
                        <ul class="mt-2">
                            <li>{% trans "Não há alunos ativos na turma selecionada." %}</li>
                            <li>{% trans "Nenhum aluno foi convocado nas etapas anteriores." %}</li>
                            <li>{% trans "Houve um problema na seleção de turma ou atividades." %}</li>
                        </ul>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Interface Modo Individual -->
                <div id="interface-modo-individual" style="display: none;">
                    {% if alunos %}
                    <div class="mb-3">
                        <div class="alert alert-primary">
                            <i class="fas fa-info-circle me-2"></i>
                            {% trans "Modo Individual: Marque a presença de cada aluno para cada atividade separadamente." %}
                            <br><small>{% trans "Cada atividade pode ter diferentes alunos presentes/ausentes." %}</small>
                        </div>
                    </div>

                    <div class="accordion" id="accordionAtividadesIndividual">
                        {% for atividade_info in atividades_detalhadas %}
                        <div class="card mb-3 border-secondary">
                            <div class="card-header border-secondary" id="heading-atividade-{{ forloop.counter0 }}">
                                <h6 class="mb-0">
                                    <button class="btn btn-link w-100 text-start collapsed text-decoration-none text-dark fw-bold" 
                                            type="button" 
                                            data-bs-toggle="collapse" 
                                            data-bs-target="#collapse-atividade-{{ forloop.counter0 }}" 
                                            aria-expanded="false" 
                                            aria-controls="collapse-atividade-{{ forloop.counter0 }}">
                                        <i class="fas fa-graduation-cap me-2"></i>
                                        {{ atividade_info }}
                                        <i class="fas fa-chevron-down float-end mt-1"></i>
                                    </button>
                                </h6>
                            </div>
                            <div id="collapse-atividade-{{ forloop.counter0 }}" 
                                 class="collapse" 
                                 data-bs-parent="#accordionAtividadesIndividual">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h6 class="text-secondary mb-0">{% trans "Marcar presença dos alunos:" %}</h6>
                                                <div>
                                                    <button type="button" class="btn btn-sm btn-outline-success me-1" 
                                                            onclick="marcarTodosPresentes({{ forloop.counter0 }})">
                                                        <i class="fas fa-check"></i> {% trans "Todos Presentes" %}
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-outline-danger" 
                                                            onclick="marcarTodosAusentes({{ forloop.counter0 }})">
                                                        <i class="fas fa-times"></i> {% trans "Todos Ausentes" %}
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            {% for aluno in alunos %}
                                            <div class="aluno-row border-bottom pb-2 mb-2">
                                                <div class="d-flex align-items-center">
                                                    <input type="checkbox" 
                                                           class="form-check-input aluno-checkbox" 
                                                           name="atividade_{{ forloop.parentloop.counter0 }}_aluno_{{ aluno.cpf }}"
                                                           id="ativ_{{ forloop.parentloop.counter0 }}_aluno_{{ aluno.cpf }}"
                                                           value="presente" 
                                                           checked
                                                           onchange="toggleJustificativa('{{ forloop.parentloop.counter0 }}', '{{ aluno.cpf }}', this)">
                                                    <label class="form-check-label flex-grow-1" 
                                                           for="ativ_{{ forloop.parentloop.counter0 }}_aluno_{{ aluno.cpf }}">
                                                        <strong>{{ aluno.nome }}</strong>
                                                        <small class="text-muted d-block">CPF: {{ aluno.cpf }}</small>
                                                    </label>
                                                </div>
                                                <div class="justificativa-container mt-2" 
                                                     id="justificativa_{{ forloop.parentloop.counter0 }}_{{ aluno.cpf }}" 
                                                     style="display: none;">
                                                    <input type="text" 
                                                           class="form-control form-control-sm justificativa-field" 
                                                           name="atividade_{{ forloop.parentloop.counter0 }}_justificativa_{{ aluno.cpf }}"
                                                           placeholder="{% trans 'Justificativa da ausência (opcional)' %}">
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="alert alert-warning mt-3" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        {% trans "Nenhum aluno disponível para marcação individual." %}
                    </div>
                    {% endif %}
                </div>
                
                <div class="mt-4">
                    <button type="submit" class="btn btn-success me-2" aria-label="{% trans 'Finalizar registro de presenças' %}">
                        <i class="fas fa-check me-2"></i>{% trans "Finalizar Registro" %}
                    </button>
                    <a href="{% url 'presencas:registrar_presenca_dias_atividades' %}" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-arrow-left me-2"></i>{% trans "Etapa Anterior" %}
                    </a>
                    <a href="{% url 'presencas:registrar_presenca_dados_basicos' %}" class="btn btn-outline-info">
                        <i class="fas fa-home me-2"></i>{% trans "Recomeçar" %}
                    </a>
                </div>
            </form>
            
            <div id="form-errors" class="alert alert-danger mt-3 d-none" role="alert"></div>
            <div id="ajax-error" class="alert alert-danger mt-3 d-none" role="alert"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'presencas/js/convocacao.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Alternar entre modos
    const modoLote = document.getElementById('modo_lote');
    const modoIndividual = document.getElementById('modo_individual');
    const interfaceLote = document.getElementById('interface-modo-lote');
    const interfaceIndividual = document.getElementById('interface-modo-individual');
    
    function alternarModo() {
        if (modoIndividual && modoIndividual.checked) {
            if (interfaceLote) interfaceLote.style.display = 'none';
            if (interfaceIndividual) interfaceIndividual.style.display = 'block';
        } else {
            if (interfaceLote) interfaceLote.style.display = 'block';
            if (interfaceIndividual) interfaceIndividual.style.display = 'none';
        }
    }
    
    if (modoLote && modoIndividual) {
        modoLote.addEventListener('change', alternarModo);
        modoIndividual.addEventListener('change', alternarModo);
    }
    
    // Inicializar no modo lote
    alternarModo();
    
    // Funcionalidade do modo lote (original)
    document.querySelectorAll('.toggle-presenca').forEach(function(toggle) {
        toggle.addEventListener('change', function() {
            const alunoCpf = this.id.replace('toggle-', '');
            const badgePresente = document.getElementById('badge-presente-' + alunoCpf);
            const badgeAusente = document.getElementById('badge-ausente-' + alunoCpf);
            const justificativaGroup = document.getElementById('justificativa-group-' + alunoCpf);
            const justificativaInput = document.getElementById('justificativa-' + alunoCpf);
            const card = document.getElementById('card-' + alunoCpf);
            
            if (this.checked) {
                // Marcar como ausente
                badgePresente.classList.add('d-none');
                badgeAusente.classList.remove('d-none');
                justificativaGroup.classList.remove('d-none');
                justificativaInput.required = false;
                this.setAttribute('aria-checked', 'true');
                card.classList.remove('presente');
                card.classList.add('ausente');
            } else {
                // Marcar como presente
                badgePresente.classList.remove('d-none');
                badgeAusente.classList.add('d-none');
                justificativaGroup.classList.add('d-none');
                justificativaInput.required = false;
                justificativaInput.value = '';
                this.setAttribute('aria-checked', 'false');
                card.classList.remove('ausente');
                card.classList.add('presente');
            }
        });
    });
    
    // Funcionalidades do modo individual
    window.toggleJustificativa = function(atividadeIndex, alunoCpf, checkbox) {
        const justificativaContainer = document.getElementById(`justificativa_${atividadeIndex}_${alunoCpf}`);
        if (checkbox.checked) {
            justificativaContainer.style.display = 'none';
        } else {
            justificativaContainer.style.display = 'block';
        }
    };
    
    window.marcarTodosPresentes = function(atividadeIndex) {
        const checkboxes = document.querySelectorAll(`input[name^="atividade_${atividadeIndex}_aluno_"]`);
        checkboxes.forEach(function(checkbox) {
            checkbox.checked = true;
            const alunoCpf = checkbox.name.replace(`atividade_${atividadeIndex}_aluno_`, '');
            const justificativaContainer = document.getElementById(`justificativa_${atividadeIndex}_${alunoCpf}`);
            if (justificativaContainer) {
                justificativaContainer.style.display = 'none';
            }
        });
    };
    
    window.marcarTodosAusentes = function(atividadeIndex) {
        const checkboxes = document.querySelectorAll(`input[name^="atividade_${atividadeIndex}_aluno_"]`);
        checkboxes.forEach(function(checkbox) {
            checkbox.checked = false;
            const alunoCpf = checkbox.name.replace(`atividade_${atividadeIndex}_aluno_`, '');
            const justificativaContainer = document.getElementById(`justificativa_${atividadeIndex}_${alunoCpf}`);
            if (justificativaContainer) {
                justificativaContainer.style.display = 'block';
            }
        });
    };
    
    // Submissão do formulário
    const form = document.getElementById('form-alunos-presenca');
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Detectar modo selecionado
        const modoSelecionado = document.querySelector('input[name="modo_marcacao"]:checked').value;
        
        const formData = new FormData(form);
        
        if (modoSelecionado === 'lote') {
            // Processamento do modo lote (original)
            document.querySelectorAll('.toggle-presenca').forEach(function(toggle) {
                if (!toggle.checked) {
                    formData.set(toggle.name, 'presente');
                }
            });
        }
        // Para modo individual, os dados já estão corretos no FormData
        
        fetch("{% url 'presencas:registrar_presenca_alunos_ajax' %}", {
            method: "POST",
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = data.redirect_url;
            } else if (data.errors) {
                let errorDiv = document.getElementById('form-errors');
                errorDiv.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i>';
                for (const [field, errors] of Object.entries(data.errors)) {
                    errorDiv.innerHTML += `<strong>${field}:</strong> ${errors.join('<br>')}<br>`;
                }
                errorDiv.classList.remove('d-none');
            } else if (data.erro) {
                let ajaxError = document.getElementById('ajax-error');
                ajaxError.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>' + data.erro;
                ajaxError.classList.remove('d-none');
            }
        })
        .catch(error => {
            let ajaxError = document.getElementById('ajax-error');
            ajaxError.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>{% trans "Erro de comunicação. Tente novamente." %}';
            ajaxError.classList.remove('d-none');
        });
    });
});
</script>
{% endblock %}